# AI駆動開発フレームワーク セットアップログ

**日付:** 2025年7月30日
**ブランチ:** `feature/setup-ai-context-framework`

## 目的

AI（Gemini）がプロジェクトのコンテキスト（目的、技術ルール、作業状況）をセッション間で効率的に引き継ぎ、自律的かつ一貫性のある開発を実現するための情報アーキテクチャを設計・構築する。

## 議論と意思決定の過程

### 1. 初期アーキテクチャの設計 (2025/07/30)

-   **概要:** `GEMINI/`ディレクトリを導入し、憲法・技術ガイド・作業ログの3つのコアファイルでAIのコンテキストを管理する初期案をAIが提示。人間からのフィードバック（手動変更の許容、ログの分割、仕様書の配置など）を受け、対話を通じてアーキテクチャを洗練させた。
-   **結果:** `GEMINI/`配下に憲法と技術ガイドを、ログは`GEMINI/logs/`に分離、仕様書は`games/[slug]/`に残す形で合意。

### 2. 既存ドキュメントの統合 (2025/07/30)

-   **概要:** `project-docs/`配下の既存ドキュメントの内容を、新しく作成した`GEMINI/`配下のファイル群に統合し、古いドキュメントは削除。情報ソースの一元化を達成した。

### 3. 最終ワークフローの確立 (2025/07/30)

-   **課題:** トークン効率、運用の簡素化、人間とAIの役割分担の明確化。
-   **解決策:**
    1.  **動的コンテキストファイルの導入:** `docs/ai-workflow/3-session-context.md`を唯一の「エントリーポイント」とし、AIはここから必要な情報を再帰的に参照する。トークン消費を最小限に抑える。
    2.  **コンテキストのブランチ連動:** `docs/ai-workflow/3-session-context.md`をバージョン管理対象とし、ブランチと共にコンテキストが自動で切り替わる仕組みを導入。並行作業を可能にする。
    3.  **コンテキスト・リセット:** 新規タスク開始時に、AIは`docs/ai-workflow/3-session-context.md`のタスク情報をリセットし、コンテキスト汚染を防ぐ。
    4.  **人間向けガイドの作成:** 人間が守るべきルール（セッション開始方法など）を`docs/project-info/human-guide.md`に明記する。
    5.  **AIの責務拡大:** ブランチ作成、コミット、プッシュの主導権をAIに委ね、人間は承認に徹する。このルールを`docs/ai-workflow/2-technical-guide.md`に追記する。

### 4. 最終アーキテクチャのリファクタリング (2025/07/30)

-   **課題:** `GEMINI/`ディレクトリ内のファイル命名規則の不統一、`GEMINI/`と`project-docs/`の責務の曖昧さ、`prompt_template.txt`の独立性。
-   **解決策:**
    1.  **`docs/`ディレクトリの新設:** ドキュメントのルートディレクトリとして`docs/`を新設。`index.md`をエントリーポイントとする。
    2.  **`ai-workflow/`と`project-info/`への分割:** `docs/`配下を、AIが直接利用する`ai-workflow/`と、人間向けの運用情報`project-info/`に分割。
    3.  **命名規則の統一:** すべてのディレクトリ名、ファイル名を小文字・ハイフン区切りに統一。
    4.  **`GEMINI/`の純化:** `docs/ai-workflow/`に移動したAI関連ファイルは、`1-`, `2-`, `3-`の番号で処理順序と重要度を示す。
    5.  **`prompt_template.txt`の廃止:** その内容を`docs/project-info/human-guide.md`内にコードスニペットとして統合。
    6.  **`docs`名称の採用:** Next.jsとの競合の可能性を認識しつつも、一般的な慣習として`docs`を採用。問題発生時は再検討。
    7.  **ゲーム仕様書の配置再確認:** `manifest.json`などのゲーム仕様は、ゲームの実装の一部であり、コードから参照されるデータであるため、`games/[slug]/`配下に留めることを再確認。

-   **最終的なアーキテクチャ:**

    '''
    /
    ├── docs/
    │   ├── index.md                 (ドキュメントのエントリーポイント/目次)
    │   │
    │   ├── ai-workflow/             (AIが直接利用する情報)
    │   │   ├── 1-project-manifest.md  (プロジェクト憲法)
    │   │   ├── 2-technical-guide.md   (技術ガイド)
    │   │   ├── 3-session-context.md   (動的セッションコンテキスト)
    │   │   └── logs/                  (AI生成ログ)
    │   │       ├── system.log
    │   │       └── games/
    │   │           └── [slug].log
    │   │
    │   └── project-info/            (人間向けの運用情報とプロジェクト記録)
    │       ├── human-guide.md         (promptテンプレートを内包)
    │       └── setup-log.md           (セットアップログ/議事録)
    │
    └── games/
        └── [slug]/
            ├── manifest.json          (ゲーム仕様: 実装の一部)
            └── ...                    (ゲームのコード)
    '''

### 5. `SETUP_LOG.md`の自律的更新に関する議論 (2025/07/30)

-   **課題:** AIが`SETUP_LOG.md`を自発的に、かつ正確に更新できていない。人間からの繰り返しのご指摘により、この問題が顕在化した。
-   **解決策:**
    1.  **責務の明確化:** `docs/ai-workflow/2-technical-guide.md`に「AIのログ管理責務」に関する明確なルールを追加する。
    2.  **プロアクティブな行動:** AIは、議論の過程や意思決定の背景など、`SETUP_LOG.md`に記録すべき内容が発生した際に、自律的にその内容を追記する。
    3.  **本議論の記録:** この`SETUP_LOG.md`の更新に関する議論自体を、ここに記録する。

### 6. ドキュメントのプロアクティブな更新に関する議論 (2025/07/30)

-   **課題:** AIが特定のドキュメント（例: `SETUP_LOG.md`）の更新に限定され、議論の文脈から関連する他のドキュメントへの影響を自律的に判断し、更新できていない。
-   **解決策:**
    1.  **包括的な責務の追加:** `docs/ai-workflow/2-technical-guide.md`に「AIのドキュメント管理責務」として、議論や意思決定がどのドキュメントに影響を与えるかを自律的に判断し、関連するすべてのドキュメントをプロアクティブに更新するルールを追加する。
    2.  **本議論の記録:** この`docs/project-info/setup-log.md`の更新に関する議論自体を、ここに記録する。

---

**日付:** 2025年7月31日
**ブランチ:** `fix/tictactoe-link`, `docs/organize-markdown`

## 目的

GitHub Pagesで発生したリンク切れ問題の修正と、それに伴うプロジェクト全体のドキュメントルールの見直しと整理。

## 議論と意思決定の過程

### 1. GitHub Pagesのパス問題修正
- **課題:** GitHub Pagesデプロイ時に、リポジリ名がパスに含まれないためリンクが機能しない。
- **解決策:** `next.config.ts`に`basePath`と`assetPrefix`を設定。ローカル開発に影響が出ないよう、`process.env.NODE_ENV`を利用して本番ビルド時のみ有効になるようにした。

### 2. AI協業ワークフローの明確化
- **課題:** AIの責務と人間の責務の境界が曖昧で、AIによるドキュメントの自律的更新が機能していなかった。
- **解決策:** `technical-guide.md`に「ドキュメントの所有権と更新責務」を定義。各ドキュメントの責任分界点を明確にした。

### 3. ドキュメントの全体精査と再編成
- **課題:** ドキュメント間に矛盾（`README.md`と`technical-guide.md`の開発手順）や不整合（`human-guide.md`のPR手順の欠如）が存在。また、ログが適切に記録されていなかった。
- **解決策:** 全体精査を実施し、矛盾点を修正。ログの役割を「議事録」と「作業ログ」に再定義し、それぞれの責務をルール化した。

---

**日付:** 2025年8月1日
**ブランチ:** `feature/refine-game-structure`

## 目的
ゲームの量産体制構築に向けた共通基盤の整備とドキュメント標準化。

## 議論と意思決定の過程

### 1. ゲーム共通UIレイアウトの導入
- **概要:** 全ゲームで共通利用可能な `GameLayout.tsx` を導入し、ゲーム名表示、ナビゲーション、ゲーム本体の表示領域を標準化した。Markdownコンテンツ表示のため `MarkdownViewer.tsx` を導入。

### 2. ゲーム仕様書（rules.md, spec.md）の標準化
- **概要:** `rules.md`（ユーザー向け）と `spec.md`（開発者・AI向け）の標準フォーマットを定義し、一貫性のあるドキュメント作成を義務付けた。新規ゲームにはこのフォーマットを強制適用し、既存ゲームには段階的に適用する運用方針を決定。

### 3. AIの行動規範の追加
- **概要:** AIがドキュメント作成時および質問生成時に、文脈を読み取り、質問を簡素化し、不明な情報を勝手に判断しないという行動規範を明文化した。

### 4. ルール表示の方針転換
- **概要:** 当初モーダルでのルール表示を計画したが、技術的課題（CSS適用、状態管理の複雑性）が解決困難であったため、ルール表示を独立したページに切り替える方針を決定した。これにより、開発のブロックを解消し、機能提供を優先する。
- **背景とトレードオフ:** モーダル表示はUXの観点から魅力的であったが、実装上の複雑性とデバッグの困難さから、現時点での採用を見送った。別ページ表示とすることで、機能の早期提供と安定性を優先した。将来的に技術的課題が解決されれば、モーダル表示への再検討も可能である。

---

## 2025-08-02
**ブランチ:** `feature/update-supported-environments`

## 目的
プロジェクトのサポート対象環境を定義し、古い環境をサポートしない理由を明確にする。

## 議論と意思決定の過程

### 1. 古いモバイルOSサポートの検討と断念
- **課題:** iOS 9 / Android 7 などの古いモバイルOSでの動作可否。
- **検討結果:**
    - **技術スタックとの非互換性:** Next.js (v15) および React (v19) はモダンブラウザ（ES2015以降を完全にサポートするブラウザ）を前提としており、古いブラウザではJavaScriptのシンタックスエラーやCSSの互換性問題が発生する可能性が非常に高い。
    - **複雑なビルド設定:** 古いブラウザに対応させるためには、Babelによる複雑なトランスパイルやポリフィルの導入が必要となり、Next.jsの内部ビルドプロセスへの深い介入が求められる。これは設定が煩雑で壊れやすい。
    - **Tailwind CSSの互換性:** Tailwind CSS v4はCSS変数を多用しており、古いブラウザではサポートされていないため、スタイルが適用されない問題が発生。
- **結論:** 現在の技術スタックを維持したまま古いOSをサポートすることは現実的ではないと判断。多大な労力と保守コストがかかり、技術的負債となるため、サポート対象外とすることを決定した。
- **代替案:** どうしても古いデバイスをサポートする必要がある場合は、Next.jsやReactの使用を諦め、素のJavaScript（ES5）に近い、あるいは軽量なライブラリを使用するアプローチを検討する必要がある。

### 2. サポート対象環境の定義
- **課題:** プロジェクトのサポート対象環境を明確に定義し、開発の指針とする。
- **決定事項:**
    - **モバイルOS:** iOS 12以降、Android 9以降を基準とする。
    - **PCブラウザ:** OSバージョンではなく、ブラウザバージョンを基準とする。主要ブラウザ（Chrome, Firefox, Edge, Safari）の最新2バージョンをサポート対象とする。
    - **開発の主軸:** 開発および主要な動作確認はGoogle Chromeの最新バージョンで行うことを明記。
- **理由:** Webアプリケーションはブラウザ上で動作するため、OSよりもブラウザのバージョンが直接的な互換性に影響する。主要ブラウザの自動更新モデルにより、多くのユーザーが最新バージョンを利用しているため、最新のWeb標準を活用しつつ広範なユーザーをカバーできる。

---

**日付:** 2025年8月2日
**ブランチ:** `feature/reversi`

## 目的
新規ゲーム「リバーシ」の実装と、それに伴う技術的課題の解決および開発ガイドラインの更新。

## 議論と意思決定の過程

### 1. ゲームの動的読み込みに関する課題
- **課題:** 新規ゲームを追加する際、`app/games/[slug]/GameLoader.tsx` を手動で修正する必要がある。これは修正漏れのリスクがあり、スケーラビリティに欠ける。
- **暫定対応:** 今回はリバーシの読み込み処理を直接追記することで対応。
- **将来的な展望:** `GameLoader.tsx` をリファクタリングし、`games` ディレクトリ内のコンポーネントを動的に、かつ自動的に読み込む仕組みを検討する。これにより、将来のゲーム追加時に `GameLoader.tsx` を修正する必要がなくなる。

### 2. スタイリング方針の決定
- **課題:** `next/dynamic` で読み込んだコンポーネントに対して、Tailwind CSSのクラスがビルド時に正しく適用されず、表示崩れが発生した。
- **解決策:** 既存の三目並べの実装を参考に、Tailwind CSSのクラスではなく、インラインスタイル (`style={{...}}`) を使用してスタイリングを行う方針を決定。
- **理由:** 動的コンポーネントにおけるスタイルの適用を安定させ、意図しない表示崩れを防ぐため。
- **ドキュメント化:** この方針を `docs/ai-workflow/2-technical-guide.md` に「スタイリングの優先順位」として明記し、今後の開発における一貫性を確保する。

---

## 2025-08-02: Node.jsバージョンアップ

### 経緯
Gemini CLIのバージョンアップに伴い、Node.jsのバージョンに互換性の問題が発生したため、プロジェクトで使用するNode.jsのバージョンを `18.18.0` から `20.18.1` に更新しました。

### 変更内容
- `.node-version` を `20.18.1` に更新。
- `.github/workflows/deploy.yml` に記載されたNode.jsのバージョンを `20.18.1` に更新。
- `package-lock.json` を再生成し、依存関係を更新。

### 影響
- `npm run build` および `npm run lint` が正常に完了することを確認済み。
- 開発環境およびデプロイ環境のNode.jsバージョンが統一された。

---

**日付:** 2025年8月3日
**ブランチ:** `feature/refactor-tictactoe`

## 目的
ゲームのViewとコアロジックの分離、仕様書の分割、命名規則の統一、およびドキュメント表示の改善。

## 議論と意思決定の過程

### 1. ゲームのロジックとビューの分離
- **課題:**
既存ゲーム（◯×ゲーム、リバーシ）のコードがロジックとビューで密結合しており、テストや保守が困難。
- **解決策:**
    - 各ゲームのコアロジックを `core.ts`ファイルに分離し、UIに依存しない純粋なロジックを記述。
    - ビューコンポーネント (`index.tsx`) は `core.ts`から提供される状態を描画することに専念。
    - スタイリングは `index.tsx` 内のStyle Object形式で定義し、JSX内でのインラインスタイルを禁止。
- **結果:** ◯×ゲームとリバーシの両方でロジックとビューの分離を完了。

### 2. システム仕様書の分割と自然言語化
- **課題:** `spec.md`がロジックと表示の両方の仕様を混在させており、テストのインプットとして使いにくい。また、実装に依存した記述が含まれる。
- **解決策:**
    - `spec.md` を廃止し、新たに「システム動作仕様 (`spec-action.md`)」と「システム表示仕様 (`spec-display.md`)」の2ファイルに分割。
    - 各仕様書は、特定のプログラミング言語の構文や関数名など、実装に依存する用語を使わず、自然言語で記述することをルール化。
    - `manifest.json` の仕様を更新し、新しい仕様書ファイルへのパスを定義。
- **結果:** ◯×ゲームとリバーシの仕様書を新しいルールに従って分割・記述。

### 3. ゲーム名の命名規則と表示の統一
- **課題:**
ゲーム名の表記に「三目並べ」「Tic-Tac-Toe」「○×ゲーム」といった表記ゆれがあり、UI表示と内部管理で一貫性がない。
- **解決策:**
    - `GameManifest` 型に `displayName` (UI表示名) と `shortDescription`(簡潔な説明) を追加。
    - `manifest.name` は内部的な正式名称（英語推奨）として使用。
    - トップページやrulesページでのゲーム名表示に `displayName` と`shortDescription` を使用するよう修正。
- **結果:** プロジェクト全体でゲーム名の表記と表示が一貫するように修正。

### 4. ドキュメント表示の改善
- **課題:**
以前の試みで仕様書へのリンクが404エラーとなる問題が発生。また、仕様書を個別のリンクで表示するのではなく、rulesページに統合して表示したい。
- **解決策:**
    - `app/games/[slug]/rules/page.tsx` を修正し、`rules.md`、`spec-action.md`、`spec-display.md` の内容を読み込み、単一のページに統合して表示。
    - `GameLayout.tsx` からのリンクは引き続きrulesページのみを指すように維持。
    - 404エラーの原因となっていたルーティングの問題を解消し、元のrulesページ表示機能に戻す。
- **結果:**
rulesページからゲームのルール、動作仕様、表示仕様をまとめて確認できるようになり、404エラーも解消。

### 5. 技術ガイドへのルール反映
- **課題:** 今回の議論で決定した「ロジックとビューの分離」「Style Object形式の採用」「仕様書の分割と自然言語化」「ゲーム名の命名規則」といった重要なルールが技術ガイドに反映されていない。
- **解決策:** `docs/ai-workflow/2-technical-guide.md`を更新し、上記ルールを明確に記述。
- **結果:** プロジェクトの公式な開発標準として、これらのルールが明文化された。

### 6. 残課題のIssue化に関する議論
- **課題:**
本セッションで完了しなかった、または今後のタスクとして残る課題を明確にする。
- **解決策:**
    - ゲームコアロジックのユニットテスト導入
    - ゲームビューコンポーネントのUIテスト導入
    - 各ゲームのUI/UXに関する細かな調整
    上記3点をIssueとして提案。
- **結果:** 人間からの承認を得て、これらの課題をIssueとして管理する方針を決定。

---

## 2025-08-04

-   **タスク:** ゲームコアロジックの単体テスト導入と品質保証体制の強化
-   **ブランチ:** `feature/unit-testing`
-   **作業概要:**
    -   `vitest` を導入し、三目並べとリバーシのコアロジック (`core.ts`) の単体テストコードを追加。
    -   `husky` と `lint-staged` を使用し、コミット前に変更されたファイルに関連するテスト、リンティング、ビルドが自動実行されるよう設定。
    -   GitHub Actions の CI/CD ワークフロー (`deploy.yml`) を更新し、プルリクエスト作成・更新時にテストとビルドが実行されるように設定。
    -   `docs/ai-workflow/2-technical-guide.md` に、テストに関する新しいルールと、ライセンスファイル更新時の厳格な手順を追記。
    -   `public/licenses.txt` に新規導入ライブラリのライセンス情報を追記。
    -   テストコードの可読性向上のため、全てのテストタイトルを日本語に修正。

---

## 2025-08-05

-   **タスク:** リバーシのUI/UX改善
-   **ブランチ:** `feature/reversi-visual-update`
-   **作業概要:**
    -   リバーシのUIを、テキストベースから駒のアイコンを用いた直感的なデザインに変更。
    -   優勢なプレイヤーのスコアを赤色でハイライトする機能を追加。
    -   アニメーション中の操作ガードやリスタート機能を追加し、操作性を向上。
    -   UI/UXの変更に伴い、関連する仕様書 (`spec-action.md`, `spec-display.md`) を更新。
    -   Hydration Errorを修正するため、HTMLのタグ構造を修正。

---

## 2025-08-05

-   **タスク:** リバーシにヒント機能を追加し、UIを改善する。
-   **ブランチ:** `feature/reversi-hint-function`
-   **作業概要:**
    -   トグル動作する「おしえて！」ボタンを配置し、ヒントの表示レベルを切り替え可能に。
    -   ヒントレベルは「ヒントなし」「おけるばしょ」「ぜんぶヒント」の3段階。
    -   「ぜんぶヒント」モードでは、選択したセルのハイライト表示と、ひっくり返る駒のハイライト、ひっくり返らない駒のグレーアウト表示。
    -   モバイルでの操作性を考慮し、「ぜんぶヒント」モードでのタップ操作を改善。
    -   ボタンの見た目を調整し、長押し時のメニュー表示を無効化。
    -   上記変更に伴い、関連する仕様書を更新。

---

## 2025-08-05

-   **タスク:** リバーシのUI調整と機能改善
-   **ブランチ:** `feat/reversi-ui-improvements`
-   **作業概要:**
    -   「はじめから」ボタンと「ヒント」ボタンのサイズを統一。
    -   「はじめから」ボタンを赤色に変更し、確認ポップアップを追加。
    -   「ばしょヒント」の表示色を現在のターンのコマの色に合わせる。
    -   「ばしょ/ぜんぶヒント」の両方で、おける場所のボードの色を調整。

---

## 2025-08-05

-   **タスク:** リバーシに履歴再生機能を追加
-   **ブランチ:** `feat/reversi-history-playback`
-   **作業概要:**
    -   ゲームの状態を履歴として記録し、巻き戻し・早送りが可能に。
    -   履歴操作ボタンが操作できない場合にグレーアウト表示されるように修正。
    -   ひっくり返すアニメーション中に駒の色がリアルタイムで更新されるように修正。

---

**日付:** 2025年8月7日
**ブランチ:** `feature/codespaces-support`

## 目的

プロジェクトをGithub Codespaces上で開発可能にし、スマートフォン等の別デバイスからのアクセスを容易にすることで、開発の柔軟性を向上させる。

## 議論と意思決定の過程

### 1. Codespaces環境の定義
- **課題:** 新しい開発者が環境をセットアップする際の手間を削減し、誰でも同じ開発環境を即座に利用できるようにしたい。
- **解決策:** `.devcontainer/devcontainer.json` を導入。コンテナ起動時に `npm install` が自動で実行されるように設定し、手動でのセットアップ作業を不要にした。
- **議論:** 当初、Codespacesのデフォルトイメージに含まれる `git-lfs` のセットアップスクリプトと、プロジェクトの `husky` の pre-push フックが競合し、ビルドに失敗。`git-lfs` を含まない、より基本的なNode.jsイメージ (`mcr.microsoft.com/devcontainers/javascript-node:1-20-bullseye`) に変更することで問題を解決した。

### 2. 開発サーバーの外部アクセス対応
- **課題:** デフォルトの `next dev` コマンドは `localhost` でサーバーを起動するため、Codespaces環境外のデバイス（スマートフォンなど）からアクセスできない。
- **解決策:** `package.json` の `dev` スクリプトを `next dev -H 0.0.0.0` に変更。これにより、コンテナのすべてのネットワークインターフェースで待受状態となり、ポートフォワーディング経経由での外部アクセスが可能になった。
- **セキュリティ:** Codespacesのポートフォワーディングはデフォルトでプライベート（認証されたユーザーのみアクセス可能）であるため、セキュリティ上のリスクは低いと判断。

### 3. Gemini CLIの導入方法
- **課題:** Codespaces環境でGemini CLIを利用可能にする必要がある。
- **議論:** 
    - **初期案:** `npm install -g @google/gemini-cli` を `postCreateCommand` に追加する案が挙がった。
    - **問題点:** グローバルインストールは、プロジェクトで管理されているNode.jsバージョンとの不整合や、依存関係の不明瞭化を招く可能性がある。
    - **最終決定:** `@google/gemini-cli` をプロジェクトの `devDependencies` として `package.json` に追加する方針を採択。これにより、`npm install` だけでCLIもインストールされ、`npm run gemini` (または `npx gemini`) でバージョン管理されたCLIを実行できるようになった。この方法は、環境の再現性と依存関係管理の観点から優れていると判断。

---

**日付:** 2025年8月9日
**ブランチ:** `feat/issue-52`

## 目的
AI開発支援ツール利用時の開発ワークフローを改善するため、コミット時の品質チェックを廃止し、プッシュ前のチェックに移行する。

## 議論と意思決定の過程

### 1. pre-commitフックの問題点
- **課題:** AI開発支援ツール（Jules）の利用時、コミットごとに実行されるpre-commitフック（`lint-staged`）が開発ワークフローの妨げとなっていた。
  - AIが内部的に生成する一時的なコミットに対してもチェックが実行されるため、処理に時間がかかり、ツールのタイムアウトを引き起こしていた。

### 2. ワークフローの変更
- **議論:** 当初、pre-commitで実行していた処理を単純にpre-pushに移行する案が検討された。しかし、`lint-staged`はステージングされたファイルを対象とするため、プッシュ前のフックで実行するには不適切であると判断された。
- **決定:** 開発効率を優先し、品質チェックのタイミングをコミット時からプッシュ前に変更することを決定。
  - pre-commitフック (`.husky/pre-commit`) を廃止。
  - pre-pushフック (`.husky/pre-push`) で、プロジェクト全体を対象とした`npm run lint`、`npm run test`、`npm run build`を実行する構成に変更。
- **効果:** この変更により、ローカルでの開発自由度（特にAIツール利用時）を確保しつつ、リモートリポジトリに反映されるコードの品質は維持される。

### 3. 関連ドキュメントの更新
- **課題:** 上記ワークフローの変更に伴い、`docs/ai-workflow/2-technical-guide.md`に記載されている品質保証に関する記述が古くなった。
- **対応:** `technical-guide.md`の該当箇所を更新し、新しいpre-pushフックの動作を反映させた。

---

**日付:** 2025年8月9日
**ブランチ:** `feat/issue-52` (追記)

## 目的
`package.json`の肥大化と可読性低下を防ぐため、複雑なビルド関連コマンドを外部スクリプトファイルとして管理するアーキテクチャを導入する。

## 議論と意思決定の過程

### 1. `package.json`内スクリプトの複雑化
- **課題:** `license-update`コマンドを`package.json`に直接記述したところ、エスケープ処理が複雑になり、JSONフォーマットが壊れて`npm install`が失敗する問題が発生した。
- **議論:** `package.json`の`scripts`は、本来シンプルなコマンドを記述する場所であり、複数行にわたる複雑なロジックを埋め込むべきではない。保守性も著しく低下する。

### 2. `scripts`ディレクトリの導入
- **決定:** プロジェクトルートに`scripts`ディレクトリを新設し、ビルドや環境構築に関連する複雑な補助スクリプトは、そこにJavaScriptファイルとして格納する方針を決定。
  - `license-update`のロジックを`scripts/license-update.js`に移動。
  - `package.json`の`license-update`スクリプトは、`node scripts/license-update.js`というシンプルな呼び出しに変更。
- **効果:**
  - `package.json`の可読性と保守性を高く保つ。
  - スクリプト自体も、JSON内の文字列としてではなく、通常のJavaScriptファイルとして管理できるため、開発やデバッグが容易になる。
- **今後の指針:** 将来的に同様の補助スクリプトが必要になった場合も、`scripts`ディレクトリに集約して管理する。

## 2025年8月9日

-   **タスク:** ワークフロー改善とライセンス管理の自動化
-   **ブランチ:** `feat/issue-52`
-   **作業概要:**
    -   `package.json` の可読性・保守性向上のため、`scripts` ディレクトリを導入し、複雑なスクリプトを分離。
    -   ライセンス更新ロジックを `scripts/license-update.js` に移動し、`npm run license-update` コマンドとして集約。
    -   `npm install` 後の `postinstall` フックでライセンス更新を自動化するよう設定。
    -   CI (`.github/workflows/pr-checks.yml`) にライセンスファイルの一貫性チェックを追加し、更新忘れを防止。
    -   上記アーキテクチャ変更の意思決定を `docs/project-info/setup-log.md` に記録。
    -   `docs/ai-workflow/2-technical-guide.md` のライセンス更新ルールを新しい自動生成方式に更新。

---

## 2025年8月9日

-   **タスク:** 最終ドキュメント更新とライセンスファイル修正
-   **ブランチ:** `feat/issue-52`
-   **作業概要:**
    -   `docs/ai-workflow/3-session-context.md` と `docs/ai-workflow/logs/system.log` の更新漏れを修正。
    -   CIのライセンスチェックエラーに対応するため、`public/licenses.txt` を再生成。
    -   `scripts/license-update.js` を修正し、プラットフォーム固有の製品版オプション依存関係のライセンスも網羅的に含めるように変更。
    -   `package.json` の `license-update` コマンドを `--production` オプションに戻し、開発依存関係のライセンスが `public/licenses.txt` に含まれないように修正。

---

## 2025年8月9日

-   **タスク:** ライセンス表記の最終確認とCIの安定化
-   **ブランチ:** `feat/issue-52`
-   **作業概要:**
    -   `public/licenses.txt` のCIエラーがプラットフォーム固有のバイナリに起因することを確認。
    -   `scripts/license-update.js` を修正し、`license-checker --all` オプションで取得したライセンス情報に加えて、既知のプラットフォーム固有の製品版オプション依存関係のライセンスを明示的に含めるように変更。
    -   `package.json` の `license-update` コマンドを `npx license-checker --production --json` に戻し、開発依存関係のライセンスが `public/licenses.txt` に含まれないように修正。
    -   `public/licenses.txt` を再生成し、網羅的かつ一貫した内容であることを確認。
    -   `public/licenses.txt` にGPL/AGPLライセンスが含まれていないことを確認。LGPLライセンスは含まれるが、製品版ビルドの性質上許容される範囲であることを確認。

---

## 2025年8月9日

-   **タスク:** ライセンス表記に関する最終見解の記録
-   **ブランチ:** `feat/issue-52`
-   **作業概要:**
    -   `public/licenses.txt` に含まれるLGPLライセンスに関する詳細な見解を`docs/project-info/setup-log.md`に記録。
    -   LGPLが「弱いコピーレフト」ライセンスであること、製品版ビルドの性質上許容される範囲であること、透明性が確保されていることを明記。

---

**日付:** 2025年8月10日
**ブランチ:** `feat/test-env-setup`

## 目的
E2Eテスト(Playwright)の実行環境を整備し、ローカル開発環境とCI環境の両方で安定して動作するように修正する。また、それに伴い関連ドキュメントを更新し、開発ワークフローを改善する。

## 議論と意思決定の過程

### 1. E2Eテストのローカル実行失敗
- **課題:** 既存のE2Eテストがローカル環境で失敗する。CI上でのみ成功するように調整されており、開発体験を損なっている。
- **原因分析:**
    - `playwright.config.ts` の `webServer` 設定が、ビルド済みの静的ファイル (`out` ディレクトリ) を対象とする `npx serve out -p 3000` になっていた。
    - ローカル開発時は `npm run dev` で開発サーバーを動かすため、テスト対象のコードと `out` ディレクトリの内容に乖離があった。
    - また、Next.jsの `basePath` の扱いが静的サーバーと開発サーバーで異なり、テストが正しいURLにアクセスできていなかった。
- **解決策:** `playwright.config.ts` の `webServer.command` を `npm run dev` に変更。これにより、E2Eテストは常に最新の開発サーバーに対して実行されるようになり、ローカルとCIの環境差異が解消された。

### 2. Playwrightのセットアップ手順の統一
- **課題:** 従来は `npm install` とは別に、手動で `npx playwright install` を実行する必要があった。CIでは実行ステップが定義されていたが、ローカルでは開発者が手順を知らないとテストを実行できない。
- **解決策:** `package.json` の `postinstall` スクリプトを修正し、`npm install` の実行後に `npx playwright install --with-deps` が自動で実行されるようにした。
- **効果:** `npm install` だけでE2Eテストの実行環境が整うようになり、セットアップが簡素化された。この変更に伴い、CIワークフロー (`pr-checks.yml`) からも手動でのインストールステップを削除した。

### 3. 不要な依存関係の削除
- **課題:** `playwright.config.ts` の修正により、`serve` パッケージが不要になった。
- **解決策:** `npm uninstall serve` を実行し、不要な依存関係をプロジェクトから削除した。

### 4. 開発者向けドキュメントの改善
- **課題:** AI（私）が日本語での応答やドキュメント更新といったルールを遵守しない場合がある。
- **解決策:** `human-guide.md` の初期プロンプトテンプレートに、ルール遵守（特に日本語での記述とドキュメント更新）を強く促す一文を追加した。
- **課題:** テスト環境に関する記述が古くなっていた。
- **解決策:** `technical-guide.md` を更新し、`npm install` だけでセットアップが完了することや、ローカルでのテスト実行手順を現状に合わせて修正した。

---

**日付:** 2025年8月9日 (Jules対応分)
**ブランチ:** `feat/issue-44` (推定)

## 目的
Playwrightを導入し、プロジェクトにE2Eテストの基盤を構築する。

## 議論と意思決定の過程

### 1. VitestとPlaywrightのランナー競合
- **課題:** `npm test` を実行した際、VitestがPlaywrightのテストファイル (`tests/**`) を読み込もうとしてエラーが発生した。
- **解決策:** `vitest.config.ts` に `exclude: ['tests/**']` を追加し、Vitestのテスト対象からPlaywrightのディレクトリを明示的に除外することで、競合を回避した。

### 2. CI環境におけるbasePathの問題
- **課題:** テストサーバーはサイトをルート (`/`) として配信するが、Next.jsのビルド成果物は `basePath` (`/minimal-games-hub`) を前提としているため、CI上でページが見つからず404エラーが発生した。
- **解決策:** `next.config.ts` を修正し、環境変数 `CI` が `true` の場合は `basePath` と `assetPrefix` を無効にする設定を追加。これにより、CI環境でのビルド成果物がテストサーバーの挙動と一致するようになり、問題を解決した。
