---
title: アニマルチェス E2Eテストトラブルシューティングログ
date: 2025-08-23
tags: [E2Eテスト, Playwright, Next.js, トラブルシューティング,
アニマルチェス]
---

## 概要

新規ゲーム「アニマルチェス」のE2Eテスト（Playwright使用）において、コンポーネントが正しくレンダリングされずタイムアウトする問題が発生した。本ログは、その問題の調査と試行錯誤の過程を記録する。

## 問題の初期認識

-   `animal-chess` のE2Eテストがタイムアウトする。
-   テストケースのうち、`「初期状態で先手（プレイヤー1）のターンである」`のみパスする。
-   `main h1` やゲーム盤の要素 (`.board`)が見つからないというエラーが発生する。
-   `npm run dev`で手動でブラウザでアクセスすると、ゲームは表示される（ただし、コンソールにスタイルの警告が表示される）。

## 試行錯誤の過程と仮説検証

### 1. `GameLoader.tsx` の修正

-   **仮説:** `animal-chess`コンポーネントがアプリケーションに正しくロードされていない。
-   **対応:** `app/games/[slug]/GameLoader.tsx` に `animal-chess`のエントリを追加。
-   **結果:** 問題は解決せず。`p`タグのテストはパスするが、他のテストは引き続きタイムアウト。

### 2. `styles.ts` の追加とスタイルの競合解消

-   **仮説:** `games/animal-chess/index.tsx` が `styles.ts`をインポートしているが、ファイルが存在しないためレンダリングが失敗している。また、`border` と `borderColor` のスタイルの競合がレンダリングを妨げている。
-   **対応:** `games/animal-chess/styles.ts` を追加。`styles.ts` 内の`captureArea` の `border`プロパティをロングハンドに分割し、スタイルの競合を解消。
-   **結果:** 問題は解決せず。`p`タグのテストはパスするが、他のテストは引き続きタイムアウト。

### 3. `PieceComponent` のSVG描画の単純化

-   **仮説:** `PieceComponent`内のSVG描画ロジックが複雑で、Playwright環境でレンダリングを妨げている。
-   **対応:** `games/animal-chess/index.tsx` 内の `PieceComponent`からSVG描画ロジックを削除し、単純な `div` とテキストに置き換え。
-   **結果:** 問題は解決せず。`p`タグのテストはパスするが、他のテストは引き続きタイムアウト。

### 4. `core.ts` の `enum` から文字列リテラルへの変更

-   **仮説:** `core.ts` で使用されている `enum`
が、Next.jsの開発サーバーやPlaywright環境でのモジュール解決に問題を引き起こしている（他のゲームは文字列リテラル型を使用）。
-   **対応:** `games/animal-chess/core.ts` の `enum` を文字列リテラル型に、`index.tsx` の参照も修正。
-   **結果:** 問題は解決せず。`p`タグのテストはパスするが、他のテストは引き続きタイムアウト。

### 5. ファイルのゼロからの再作成

-   **仮説:** ファイル自体に破損や見えない不正な文字が含まれている、あるいは`cp` コマンドに起因するメタデータの問題がある。
-   **対応:** `games/animal-chess/` ディレクトリと`tests/animal-chess.spec.ts` を削除し、`write_file`で各ファイルをゼロから再作成。
-   **結果:** 問題は解決せず。`p`タグのテストはパスするが、他のテストは引き続きタイムアウト。

### 6. `manifest.json` の読み込み戦略の変更

-   **仮説:** `fs.readFileSync` による `manifest.json`の読み込みが、Playwrightの `webServer`環境でレースコンディションやファイルシステムアクセスに関する問題を引き起こしている。
-   **対応:** `games/animal-chess/manifest.json` を`public/games/animal-chess/manifest.json` に移動し、`app/games/[slug]/page.tsx` および `app/page.tsx` で `fetch` APIを使用して読み込むように変更。
-   **結果:** `Manifest not found` エラーは解消されたが、`ページのタイトルが正しく表示されている` テストは引き続きタイムアウト。

### 7. `GameLayout` コンポーネントの切り分け

-   **仮説:** `GameLayout` コンポーネントが、`animal-chess`の場合のみ正しくレンダリングされない。
-   **対応:** `app/games/[slug]/GameClientPage.tsx` で `GameLayout`の代わりに直接 `h1` タグをレンダリングするダミーコンポーネントを配置。
-   **結果:** `ページのタイトルが正しく表示されている` テストが**パスした**。これにより、`GameLayout`コンポーネントが問題の原因であることが明確になった。

### 8. `GameLayout` の原因特定と試行錯誤

-   **仮説:** `GameLayout` の Tailwind CSS クラスや `next/link`が問題を引き起こしている。
-   **対応:**
    -   `GameLayout.tsx` の `Link` コンポーネントを通常の `a`タグに置き換え。
    -   `GameLayout.tsx` のルート `div` 要素からすべての Tailwind CSSクラスを削除。
-   **結果:** いずれの対応も問題解決には至らず。`ページのタイトルが正しく表示されている` テストは引き続きタイムアウト。

## 結論と今後の課題

-   `GameLayout` コンポーネントが `animal-chess`のE2Eテストにおいて問題を引き起こしていることは明確になった。
-   しかし、その具体的な原因（Tailwind CSSの特定のクラス、`next/link`以外の依存関係、Playwright環境でのレンダリング特性など）は、このセッションの試行錯誤では特定できなかった。
-   `animal-chess` のE2Eテストを安定させるためには、`GameLayout`コンポーネントのさらなる詳細な調査、または `animal-chess` 固有の`GameLayout` の実装（他のゲームの `GameLayout`とは異なる、よりシンプルなもの）を検討する必要がある。
-
今回の問題は、Next.jsのサーバーコンポーネントとクライアントコンポーネントの
連携、Playwrightのヘッドレスブラウザ環境、そして複雑なCSSフレームワークの組
み合わせにおいて発生する、非常に特定が困難なエッジケースである可能性が高い。

## 今後の推奨事項

-   新規実装においては、**「インクリメンタルな開発と動作確認」**を徹底し、特にPlaywright環境での早期動作確認を重視する。
-コンポーネントを最小化し、各機能を追加するたびにテストを実行することで、問題の発生箇所を早期に特定する。
-   他のゲームの成功事例（特に `tictactoe`）のコードベースを参考に、コンポーネントの構造やスタイリングを厳密に合わせる。
-   もし `GameLayout` が再び問題となる場合、`animal-chess`のためだけに、よりシンプルなレイアウトコンポーネントを実装することも検討する。
