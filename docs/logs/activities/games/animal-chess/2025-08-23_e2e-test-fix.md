# アニマルチェス E2Eテスト タイムアウト問題の調査と修正

## 日付

2025年8月23日

## 問題

アニマルチェスのE2Eテスト (`tests/animal-chess.spec.ts`) が、Playwrightのテスト環境下でレンダリングタイムアウトにより失敗する。

## 調査

1.  **初期調査**: 最初にE2Eテストを実行したところ、Next.jsの開発サーバーがクラッシュしていることが判明。エラーログに `Cannot find module ... amp-context` が記録されていた。
2.  **原因分析**: `next.config.ts` を調査した結果、`output: 'export'` という静的サイト生成用の設定が、`next dev` コマンド（開発サーバー）と互換性がなく、サーバークラッシュを引き起こしていると断定した。
3.  **設定修正**: `next.config.ts` を変更し、`output: 'export'` と関連設定が本番ビルド時 (`NODE_ENV === 'production'`) のみに適用されるように修正した。
4.  **二次的な問題**: 上記修正後もテストがタイムアウトした。調査の結果、デバッグのためにバックグラウンドで実行した開発サーバーがゾンビプロセスとして残り、ポート3000を占有し続けていることが原因だと判明。
5.  **解決**: `fuser -k 3000/tcp` コマンドでポートを解放することにより、Playwrightが正常に開発サーバーを起動できるようになり、すべてのE2Eテストが成功した。

## 解決策

-   `next.config.ts` の設定を、環境変数 `NODE_ENV` に応じて動的に変更するように修正した。
-   最終的に、この修正によってE2Eテストは安定してパスするようになった。

## 副次的な修正

-   デバッグ中に誤ってコミットに含めてしまった `server.log` をリポジトリから削除し、`.gitignore` に追加した。
