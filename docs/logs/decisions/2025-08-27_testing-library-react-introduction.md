# 意思決定記録: @testing-library/react導入とテスト戦略の拡充

## 基本情報

- **日付**: 2025-08-27
- **決定者**: 開発チーム
- **影響範囲**: プロジェクト全体のテスト戦略
- **関連Issue**: リバーシ履歴機能のテストカバレッジ不足

## 背景・課題

### 発見された問題

1. **カスタムフックのテスト不足**
   - `useReversi`, `useResponsive`, `useGameStateLogger`等の詳細テストが困難
   - 履歴機能の複雑な状態管理がE2Eテストのみでは不十分

2. **テストカバレッジの限界**
   - E2Eテストだけでは条件分岐の網羅が困難
   - エラーハンドリングや細かい状態変化のテストが不可能

3. **開発効率の問題**
   - フィードバックループが長い（E2Eテストの実行時間）
   - デバッグが困難（ブラウザ環境でのみ再現）

### 現在のテスト構成（導入前）

```
テスト層                対象                     ツール
─────────────────────────────────────────────────────
E2Eテスト              ユーザー操作フロー        Playwright
ユニットテスト          ゲームコアロジック        Vitest
静的解析               コード品質               ESLint
```

## 検討した選択肢

### 選択肢1: 現状維持（E2E + コアロジックテストのみ）

**メリット**:
- 依存関係の増加なし
- 学習コストなし
- シンプルな構成維持

**デメリット**:
- カスタムフックのテスト不可
- 複雑な状態管理のテスト困難
- 開発効率の低下

### 選択肢2: @testing-library/react導入

**メリット**:
- React公式推奨のテストライブラリ
- カスタムフックの詳細テスト可能
- 高速なフィードバックループ
- 条件分岐の網羅的テスト

**デメリット**:
- 依存関係の増加
- 学習コスト
- テスト作成工数の増加

### 選択肢3: 他のテストライブラリ（Enzyme等）

**メリット**:
- 豊富な機能

**デメリット**:
- React 18+での公式サポート終了
- メンテナンス性の懸念

## 決定内容

**選択肢2: @testing-library/react導入**を採用

### 導入パッケージ

```json
{
  "devDependencies": {
    "@testing-library/react": "^14.1.2",
    "@testing-library/jest-dom": "^6.1.5"
  }
}
```

### 新しいテスト構成

```
テスト層                対象                     ツール
─────────────────────────────────────────────────────
E2Eテスト              ユーザー操作フロー        Playwright
コンポーネントテスト     React コンポーネント      @testing-library/react
フックテスト           カスタムフック           @testing-library/react
ユニットテスト          ゲームコアロジック        Vitest
静的解析               コード品質               ESLint
```

## 実装詳細

### 1. Vitest設定の更新

```typescript
// vitest.config.mts
export default defineConfig({
  test: {
    environment: 'jsdom',
    exclude: [...configDefaults.exclude, 'tests/**'],
    setupFiles: ['./vitest.setup.ts'],
  },
})
```

### 2. セットアップファイルの作成

```typescript
// vitest.setup.ts
import { expect } from 'vitest'
import * as matchers from '@testing-library/jest-dom/matchers'

expect.extend(matchers)
```

### 3. テストファイル命名規則

- **ユニットテスト**: `*.test.ts`
- **コンポーネント/フックテスト**: `*.test.tsx` / `*.test.ts`
- **E2Eテスト**: `tests/*.spec.ts`

## 導入効果の検証

### useReversiフックテストの実装

```typescript
describe('useReversi Hook', () => {
  it('履歴機能が正しく動作する', () => {
    const { result } = renderHook(() => useReversi());
    
    act(() => {
      result.current.makeMove(2, 3);
    });
    
    expect(result.current.gameHistory.length).toBe(2);
    expect(result.current.canUndo).toBe(true);
  });
});
```

**結果**: 8つのテストケースで履歴機能を完全にカバー

### テストカバレッジの向上

**Before**:
- E2Eテスト: 5項目
- ユニットテスト: 7項目（コアロジックのみ）

**After**:
- E2Eテスト: 5項目
- コンポーネント/フックテスト: 8項目（新規）
- ユニットテスト: 7項目

## 運用ガイドライン

### 1. テスト作成の優先順位

1. **必須**: コアロジックのユニットテスト
2. **推奨**: カスタムフックのテスト
3. **必要に応じて**: コンポーネントのテスト
4. **必須**: 主要フローのE2Eテスト

### 2. テスト実行戦略

**開発時**:
```bash
npm run test:unit -- --watch    # 高速フィードバック
```

**CI/CD**:
```bash
npm test                        # 全テスト実行
```

### 3. パフォーマンス考慮事項

- **並列実行**: Vitestの並列実行を活用
- **選択実行**: 変更箇所に関連するテストのみ実行
- **キャッシュ**: node_modulesのキャッシュ活用

## 今後の展開

### 短期（1-2週間）

- [ ] 既存ゲームのカスタムフックテスト追加
- [ ] 共通コンポーネントのテスト追加
- [ ] テスト作成ガイドラインの整備

### 中期（1ヶ月）

- [ ] 新規ゲーム開発時のテストテンプレート作成
- [ ] テストカバレッジレポートの導入
- [ ] CI/CDでのテスト並列実行最適化

### 長期（3ヶ月）

- [ ] ビジュアルリグレッションテストの検討
- [ ] パフォーマンステストの導入
- [ ] アクセシビリティテストの強化

## 学習リソース

### チーム向け資料

- [Testing Library公式ドキュメント](https://testing-library.com/docs/react-testing-library/intro/)
- [プロジェクトのテクニカルガイド](../rules/technical-guide-testing.md)
- [テスト戦略ドキュメント](../testing/testing-strategy.md)

### ベストプラクティス

1. **ユーザー中心のテスト**: 実装詳細ではなくユーザー体験をテスト
2. **適切な抽象化レベル**: 各テスト層の責務を明確に分離
3. **保守性重視**: テストコードも本番コードと同様に品質を保つ

## 振り返り・評価

### 成功指標

- [x] カスタムフックの詳細テストが可能になった
- [x] テスト実行時間の短縮（ユニットテスト部分）
- [x] 開発時のフィードバックループ改善
- [x] 複雑な状態管理のテストカバレッジ向上

### 課題・改善点

- テスト作成工数の増加（予想通り）
- 学習コストの発生（予想通り）
- テストファイル数の増加による管理複雑化

### 総合評価

**成功**: 導入目的を達成し、テスト品質が大幅に向上した。
今後の機能開発において、より安全で効率的な開発が可能になった。

## 関連ドキュメント

- [テクニカルガイド: テスト戦略](../rules/technical-guide-testing.md)
- [テスト戦略ドキュメント](../testing/testing-strategy.md)
- [リバーシ履歴機能実装記録](./2025-08-27_reversi-history-feature-implementation.md)