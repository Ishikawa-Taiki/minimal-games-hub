---
title: E2Eテストにおける待機方針の明確化
date: 2025-08-24
author: Gemini
---

## 決定事項

Playwrightを用いたE2Eテストにおいて、テストの安定性を確保するため、待機処理に関する方針を以下の通り明確化します。

1.  **原則として `expect` の Web-First Assertion を利用する:**
    Playwrightの `expect()` は、指定した要素が表示されるか、特定の状態になるまで自動で待機する機能を内蔵しています。`page.waitForTimeout()` のような固定時間の待機は、テストの実行を不必要に遅延させ、環境によって失敗を招く可能性があるため、**原則として使用を禁止**します。

    ```typescript
    // 良い例: 要素が表示されるまで自動で待機する
    await expect(page.getByText('勝利！')).toBeVisible();

    // 悪い例: 固定時間待機する
    await page.waitForTimeout(1000); // 使用しない
    ```

2.  **動的な状態変化の待機:**
    特定の操作後にUIが更新されるのを待つ場合も、`expect` を使用します。例えば、ボタンをクリックした後に特定のテキストが表示されることを確認する場合、そのテキストの出現を `expect` でアサーションすることで、UIの更新を確実に待機できます。

## 背景と理由

- **テストの安定性向上:** 固定時間の待機は、ローカルPCでは成功しても、CI環境のようなリソースが異なる環境ではタイミングがずれて失敗する「フレーキーテスト」の主な原因となります。Playwrightの自動待機機能を利用することで、実行環境に依存しない安定したテストを構築できます。
- **テスト実行時間の短縮:** 自動待機は、条件が満たされ次第すぐに次のステップに進むため、固定時間待機のように不必要な待ち時間が発生しません。これにより、テスト全体の実行時間を短縮できます。
- **可読性の向上:** `expect(element).toBeVisible()` のようなコードは、「この要素が表示されているはずだ」というテストの意図を明確に示しており、`waitForTimeout` よりも可読性が高まります。

この決定は、コミット `dc1b0173fa2548d56a3fb9416130b67e62a402d4` で `docs/rules/technical-guide-development-workflow.md` に反映されました。

---

**注記:** このドキュメントは、関連するコミットログを基に後から作成されたものです。開発のリアルタイムな記録ではなく、一部の情報が実際の状況と異なる可能性があります。