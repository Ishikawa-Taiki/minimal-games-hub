# 意思決定記録: 3層テスト戦略の確立

## 基本情報

- **日付**: 2025-08-27
- **決定者**: 開発チーム
- **影響範囲**: プロジェクト全体のテスト戦略
- **トリガー**: リバーシ履歴機能のテストカバレッジ不足

## 背景・動機

### 従来のテスト構成の限界

**2層構成（導入前）**:
```
E2Eテスト (Playwright)     → ユーザー操作フロー
ユニットテスト (Vitest)    → ゲームコアロジック
```

**発見された問題**:
1. **中間層の欠如**: コンポーネント・フック単体のテストが不可能
2. **テストギャップ**: E2Eとユニットの間に大きな空白
3. **デバッグ困難**: 複雑な状態管理の問題特定が困難
4. **開発効率**: フィードバックループが長い

### 具体的な課題事例

**useReversiフックの履歴機能**:
- 複雑な状態管理（履歴配列 + インデックス）
- フルヒントモードでの特殊処理
- E2Eテストだけでは条件分岐を網羅できない
- ユニットテストではReactフックをテストできない

## 新しい3層テスト戦略

### 戦略概要

```
┌─────────────────────────────────────────────────────────┐
│ E2Eテスト (Playwright)                                    │
│ - ユーザー操作フロー                                      │
│ - ブラウザ統合テスト                                      │
│ - レスポンシブ動作確認                                    │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│ コンポーネント・フックテスト (@testing-library/react)      │
│ - カスタムフックの詳細動作                                │
│ - コンポーネント単体動作                                  │
│ - 状態管理ロジック                                        │
└─────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────┐
│ ユニットテスト (Vitest)                                   │
│ - ゲームコアロジック                                      │
│ - 純粋関数のテスト                                        │
│ - ビジネスルール                                          │
└─────────────────────────────────────────────────────────┘
```

### 各層の責務と特徴

**1. E2Eテスト層**
- **責務**: エンドユーザー体験の保証
- **対象**: ページ全体、ユーザーフロー
- **実行環境**: 実ブラウザ
- **実行頻度**: CI/CD、リリース前
- **実行時間**: 長い（20-30秒）

**2. コンポーネント・フックテスト層**
- **責務**: 個別機能の詳細動作保証
- **対象**: カスタムフック、Reactコンポーネント
- **実行環境**: jsdom
- **実行頻度**: 開発中、CI/CD
- **実行時間**: 中程度（1-5秒）

**3. ユニットテスト層**
- **責務**: ビジネスロジックの正確性保証
- **対象**: 純粋関数、ゲームルール
- **実行環境**: Node.js
- **実行頻度**: 開発中、CI/CD
- **実行時間**: 短い（100ms-1秒）

## 実装詳細

### 技術スタック

**新規導入**:
```json
{
  "@testing-library/react": "^14.1.2",
  "@testing-library/jest-dom": "^6.1.5"
}
```

**設定変更**:
```typescript
// vitest.config.mts
export default defineConfig({
  test: {
    environment: 'jsdom',
    setupFiles: ['./vitest.setup.ts'],
  },
})

// vitest.setup.ts
import { expect } from 'vitest'
import * as matchers from '@testing-library/jest-dom/matchers'
expect.extend(matchers)
```

### テストパターンの確立

**カスタムフックテスト**:
```typescript
describe('useReversi Hook', () => {
  it('履歴機能が正しく動作する', () => {
    const { result } = renderHook(() => useReversi());
    
    // 初期状態確認
    expect(result.current.gameHistory.length).toBe(1);
    expect(result.current.canUndo).toBe(false);
    
    // 手番実行
    act(() => {
      result.current.makeMove(2, 3);
    });
    
    // 状態変化確認
    expect(result.current.gameHistory.length).toBe(2);
    expect(result.current.canUndo).toBe(true);
  });
});
```

**E2Eテスト**:
```typescript
test('履歴機能のユーザー操作', async ({ page }) => {
  await page.goto('/games/reversi');
  
  // 初期状態確認
  const counter = await page.locator('[data-testid="history-counter"]').textContent();
  expect(counter).toBe('1 / 1');
  
  // ユーザー操作
  await page.locator('[data-testid="cell-2-3"]').click();
  
  // UI更新確認
  const newCounter = await page.locator('[data-testid="history-counter"]').textContent();
  expect(newCounter).toBe('2 / 2');
});
```

## 効果測定

### 導入前後の比較

**テストカバレッジ**:
```
Before:
├── E2Eテスト: 5項目
└── ユニットテスト: 7項目
合計: 12項目

After:
├── E2Eテスト: 5項目
├── フックテスト: 8項目 (新規)
└── ユニットテスト: 7項目
合計: 20項目 (+67%向上)
```

**実行時間**:
```
Before:
├── E2E: 20秒
└── ユニット: 1秒
合計: 21秒

After:
├── E2E: 21秒
├── フック: 0.5秒
└── ユニット: 1秒
合計: 22.5秒 (+7%増加)
```

**開発効率**:
- **フィードバック速度**: フックテストにより中間レベルの高速フィードバック
- **デバッグ効率**: 問題箇所の特定が容易
- **リファクタリング安全性**: 詳細なテストによる安全なコード変更

### 品質指標の改善

**バグ検出能力**:
- **Before**: E2Eで統合レベルのバグのみ検出
- **After**: 各層で適切なレベルのバグを検出

**テスト安定性**:
- **E2E**: 実ブラウザ環境での確実な動作確認
- **フック**: jsdom環境での高速・安定テスト
- **ユニット**: 純粋関数の確実なテスト

## 運用ガイドライン

### テスト作成の判断基準

**E2Eテスト作成基準**:
- ✅ 主要なユーザーフロー
- ✅ レスポンシブ動作
- ✅ ページ間遷移
- ❌ 細かい状態変化
- ❌ エラーハンドリング詳細

**フックテスト作成基準**:
- ✅ カスタムフックの状態管理
- ✅ 複雑な条件分岐
- ✅ 副作用の検証
- ✅ エラーハンドリング
- ❌ 純粋な計算処理

**ユニットテスト作成基準**:
- ✅ ゲームルール
- ✅ 純粋関数
- ✅ ビジネスロジック
- ❌ UI関連処理
- ❌ React固有の処理

### 開発フロー

**新機能開発時**:
1. **ユニットテスト**: コアロジックのテスト作成
2. **フックテスト**: 状態管理のテスト作成
3. **実装**: 機能実装
4. **E2Eテスト**: ユーザーフローのテスト作成
5. **統合確認**: 全テスト実行

**バグ修正時**:
1. **再現テスト**: 該当層でのテスト作成
2. **修正実装**: バグ修正
3. **回帰テスト**: 全層でのテスト実行

## 成功要因の分析

### 技術的成功要因

**1. 適切なツール選択**:
- @testing-library/react: React公式推奨
- renderHook: カスタムフック専用API
- act: 状態更新の適切な処理

**2. 段階的導入**:
- 既存テストを維持しながら新層を追加
- リスクを最小化した導入プロセス

**3. 明確な責務分離**:
- 各層の役割を明確に定義
- 重複を避けた効率的なテスト構成

### 組織的成功要因

**1. ドキュメント化**:
- テスト戦略の文書化
- 実装ガイドラインの整備

**2. 実践的な学習**:
- 実際の課題（履歴機能）での導入
- 具体的な成果による学習効果

## 今後の展開

### 短期計画（1-2週間）

**他ゲームへの適用**:
- useTicTacToeControllerのテスト強化
- 新規ゲーム移行時のテスト実装
- テストパターンの標準化

### 中期計画（1ヶ月）

**テスト品質の向上**:
- カバレッジレポートの導入
- テストユーティリティの共通化
- CI/CDでの並列実行最適化

### 長期計画（3ヶ月）

**高度なテスト戦略**:
- ビジュアルリグレッションテスト
- パフォーマンステスト
- アクセシビリティテスト

## 学習・知見

### 技術的学習

**Testing Library哲学**:
- "ユーザーが使う方法でテストする"
- 実装詳細ではなく動作をテスト
- アクセシビリティを意識したテスト

**React Testing パターン**:
- renderHook + actの組み合わせ
- 非同期処理のテスト方法
- モックの適切な使用

### 設計上の学習

**テスト設計原則**:
- 各層の責務を明確に分離
- テストの重複を避ける
- 保守しやすいテストコード

**品質保証戦略**:
- 多層防御によるバグ検出
- 適切なレベルでの品質保証
- 開発効率との両立

## 振り返り・評価

### 成功指標の達成

- ✅ **テストカバレッジ向上**: 67%向上
- ✅ **開発効率改善**: 中間レベルの高速フィードバック
- ✅ **品質向上**: 多層防御によるバグ検出
- ✅ **保守性向上**: 安全なリファクタリング環境

### 予想外の効果

**開発者体験の向上**:
- テスト作成が楽しくなった
- コードの品質に対する意識向上
- リファクタリングへの積極性

**チーム学習の促進**:
- Testing Libraryの習得
- テスト設計スキルの向上
- 品質保証への理解深化

### 課題と改善点

**学習コスト**:
- 新しいAPIの習得時間
- テスト作成工数の増加
- 初期設定の複雑さ

**運用上の課題**:
- テストファイル数の増加
- CI/CD実行時間の微増
- テスト保守の工数

## 総合評価

**戦略的価値**:
3層テスト戦略の確立により、プロジェクトの品質保証体制が大幅に強化された。特にReactアプリケーションの複雑な状態管理に対する適切なテスト手法を確立できたことは、今後の開発において大きな価値を持つ。

**技術的成果**:
@testing-library/reactの導入により、これまでテストが困難だったカスタムフックの詳細動作を確実にテストできるようになった。これにより、複雑な機能の実装とリファクタリングが安全に行えるようになった。

**将来への影響**:
確立されたテスト戦略とパターンは、今後の全ゲーム開発において標準として適用される。これにより、プロジェクト全体の品質と保守性が継続的に向上することが期待される。

## 関連ドキュメント

- [テクニカルガイド: テスト戦略](../rules/technical-guide-testing.md)
- [@testing-library/react導入記録](./2025-08-27_testing-library-react-introduction.md)
- [Task8完了サマリー](../activities/2025-08-27_task8-completion-summary.md)
- [リバーシ履歴機能実装記録](./2025-08-27_reversi-history-feature-implementation.md)