# ライセンス管理とスクリプト規約の改定

- **日付:** 2025-08-22
- **関連:** ライセンス表記、開発ワークフロー、CI/CD

## 課題

1.  **ライセンスファイルのGit管理:** `public/licenses.txt`がGitで管理されており、開発環境の差異によって不要なコミットが発生する可能性がある。これをGit管理外にしたい。
2.  **ライセンス問題の検知:** ライセンス違反の問題は、可能な限り開発の早い段階で検知したい。
3.  **CIリソース:** Pull Requestごとのチェックで、毎回ライセンスチェックを実行すると、CIのリソースを過剰に消費する懸念がある。
4.  **開発体験:** ローカルでの開発時に、ライセンスページがファイル欠落でエラーになるのは避けたい。
5.  **スクリプトの一貫性:** `package.json`のスクリプトの命名や実行方法に一貫性がなく、AIエージェントによる自動化の信頼性を損なう可能性がある。

## 議論の経緯

当初は、`licenses.txt`をGit管理から外し、デプロイ時にのみ生成する計画だった。しかし、これではライセンス問題の検知がデプロイ時まで遅れてしまうという懸念が示された。

次に、CIで毎回チェックする案が検討されたが、リソース消費の問題が指摘された。

これらのトレードオフを解消するため、以下のハイブリッドアプローチが提案され、議論を経て詳細が固まった。

## 最終決定

### 1. 「コンプライアンスチェック」と「ページ生成」の分離

-   **コンプライアンスチェック (`test:license`):**
    -   `license-checker`を使用し、許可されていないライセンス（GPL, AGPL等）が含まれている場合に失敗するnpmスクリプト`test:license`を新設。
    -   このチェックは、PRのCIにおいて**`package-lock.json`が変更された場合のみ**実行する。これにより、依存関係の変更時にのみチェックを行い、リソース消費と早期発見のバランスを取る。
-   **ページ生成 (`update:license`):**
    -   Webサイトに表示するための`public/licenses.txt`の生成は、`update:license`スクリプトが担う。
    -   このファイルは`.gitignore`で管理対象外とする。

### 2. `package.json`スクリプトの規約統一

-   **命名規則:** すべてのスクリプトを`動詞:対象`（例: `test:unit`, `update:license`）の形式に統一。
-   **実行の集約:**
    -   `dev`および`start`スクリプト実行時に、`update:license`を自動実行し、ローカルでのファイル欠落を防ぐ。
    -   `test`スクリプトを、`test:unit`, `test:e2e`, `test:license`のすべてを実行する親スクリプトとして定義。
    -   `test:e2e`スクリプト内で`playwright install`を実行し、E2Eテストの実行準備を自動化。
-   **ルールの文書化:** 上記の規約と、「自動化タスクは必ずnpmスクリプト経由で実行する」というルールを`technical-guide-development-workflow.md`に明記。

### 3. CI/CDとGitフックの更新

-   `pr-checks.yml`, `deploy.yml`, `.husky/pre-push`で使われているスクリプトを、すべて新しい命名規則に沿ったものに更新。

## 得られた知見

-   ライセンス管理は、「コンプライアンス違反のチェック」と「ライセンスページの生成」という異なる関心事を分離することで、それぞれの目的に最適化されたワークフローを構築できる。
-   CIの条件付き実行（`if: contains(...)`）を活用することで、リソース効率と品質保証を両立できる。
-   `package.json`のスクリプトは、単なるコマンドエイリアスではなく、プロジェクトの公式なタスク実行インターフェースとして規約を定めて運用することで、開発者とAIエージェント双方にとっての信頼性とメンテナンス性が向上する。
