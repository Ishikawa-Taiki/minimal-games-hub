# 技術ガイド - レスポンシブアーキテクチャ

## 1. 概要

本ドキュメントは、本プロジェクトにおけるレスポンシブデザインの技術的なアプローチ、アーキテクチャ、およびコンポーネント構造を定義します。PCでのサイドバーレイアウトと、モバイルでのミニマルレイアウト（FAB + ボトムシート）を基本パターンとし、将来のゲーム開発で効率的かつ一貫性のあるUI/UXを提供することを目的とします。

### 背景と目的

このアーキテクチャは、以下の課題を解決するために設計されました。

-   **画面の圧迫感の解消:** スマートフォン等の狭い画面でも、ゲームボードの表示領域を最大限に確保する。
-   **UI/UXの一貫性:** ゲーム間で統一された操作性を提供し、ユーザーが直感的に学習できるようにする。
-   **開発効率の向上:** ゲーム固有の実装と共通のUI基盤を分離し、保守性と拡張性を高める。

## 2. アーキテクチャ

### 2.1. 基本方針

-   **ブレークポイント:** `768px`を境界とし、それ以上をPC、未満をモバイルと定義します。
-   **レイアウトパターン:**
    -   **PC (>= 768px):** サイドバーレイアウト。コントロールパネルを画面左側に常時表示し、一覧性を確保します。
    -   **モバイル (< 768px):** ミニマルレイアウト。ゲーム盤面を最大化し、操作はフローティングアクションボタン（FAB）とボトムシートを介して行います。
-   **実装技術:** `useResponsive`フックによる動的なレイアウト切り替えと、CSS-in-JS (`StyleSheet.create`) によるスタイリングを基本とします。

### 2.2. 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    Next.js App Router                       │
├─────────────────────────────────────────────────────────────┤
│  Responsive Layout System                                   │
│  ┌─────────────────┐  ┌─────────────────┐                 │
│  │   PC Layout     │  │  Mobile Layout  │                 │
│  │  (Sidebar)      │  │   (Minimal)     │                 │
│  └─────────────────┘  └─────────────────┘                 │
├─────────────────────────────────────────────────────────────┤
│  Common Game Architecture                                   │
│  ┌─────────────────┐  ┌─────────────────┐                 │
│  │ GameController  │  │   GameLayout    │                 │
│  │   Interface     │  │   Component     │                 │
│  └─────────────────┘  └─────────────────┘                 │
├─────────────────────────────────────────────────────────────┤
│  Individual Game Components                                 │
│  ┌─────────────────┐  ┌─────────────────┐                 │
│  │  Game Hooks     │  │  Game UI        │                 │
│  │  (useReversi)   │  │  Components     │                 │
│  └─────────────────┘  └─────────────────┘                 │
└─────────────────────────────────────────────────────────────┘
```

### 2.3. ポリモーフィックなスコア表示

新しいゲームを追加するたびに共通レイアウトコンポーネント（`GameLayout`）を修正する必要がないよう、ポリモーフィックな設計を採用しています。

-   **`getScoreInfo`メソッド:** `BaseGameController`インターフェースにオプショナルな`getScoreInfo`メソッドを定義。
-   **各ゲームの責務:** 各ゲームのコントローラー（カスタムフック）が、自身のゲームのスコアや統計情報の表示形式（`ScoreInfo`型）を決定し、このメソッドを介して`GameLayout`に提供します。
-   **`GameLayout`の責務:** `GameLayout`は提供された`ScoreInfo`を描画することに専念し、ゲーム固有のロジックを持ちません。

この設計に関する詳細な決定経緯は、[ADR-003: ポリモーフィックなスコア表示設計の採用](../../logs/decisions/2025-09-03_polymorphic-score-display-design.md)を参照してください。

## 3. 主要コンポーネントとインターフェース

### 3.1. `useResponsive` フック

このフックは、現在の画面幅に基づいてレイアウトモード (`'mobile'` または `'desktop'`) を返します。

-   **定義:** `hooks/useResponsive.ts`
-   **戻り値:** `ResponsiveState`オブジェクト (`{ layoutMode: 'mobile' | 'desktop', screenWidth: number }`)
-   **利用法:**
    ```typescript
    const responsiveState = useResponsive();

    if (isMobile(responsiveState)) {
      // モバイル用のレンダリング
    } else {
      // PC用のレンダリング
    }
    ```
-   **注意:** このフックはクライアントサイドでのみ動作します。SSR時にはデフォルト値（PC）が返されます。

### 3.2. `GameLayout` コンポーネント

すべてのゲーム画面の共通レイアウトを提供します。`useResponsive`フックの結果に応じて、PC用サイドバーレイアウトとモバイル用ミニマルレイアウトを自動的に切り替えます。

-   **定義:** `app/components/GameLayout.tsx`
-   **主要なProps:**
    -   `gameName`: ゲーム名
    -   `gameController`: 各ゲームのロジックをカプセル化したコントローラーオブジェクト
    -   `children`: ゲーム盤面など、ゲーム固有のUI
-   **責務:**
    -   レスポンシブレイアウトの適用
    -   共通コントロールパネル（ルール、リセット等）の表示
    -   `gameController`から提供される共通の状態（手番、ステータス、スコア等）の表示

### 3.3. `ControlPanel`, `FloatingActionButton`, `BottomSheet`

これらは主にモバイルレイアウトで使用されるコンポーネント群です。

-   **`FloatingActionButton` (FAB):** 画面右下に表示され、タップするとボトムシートを開きます。
-   **`BottomSheet`:** 画面下からスライドアップするモーダル。内部に`ControlPanel`をホストします。
-   **`ControlPanel`:** ゲームの操作ボタン（ルール、リset）やスコア情報を表示します。PCレイアウトではサイドバー内に直接表示されます。

## 4. 型定義

関連する主要な型は `types/game.ts` に集約されています。

-   **`GameStatus`, `Player`, `BaseGameState`:** すべてのゲームで共通の基本的な状態。
-   **`BaseGameController`:** すべてのゲームコントローラーが準拠すべき共通インターフェース。`gameState`, `resetGame`, `getDisplayStatus`, `getScoreInfo`などが定義されています。
-   **`ScoreInfo`:** `getScoreInfo`メソッドが返すスコア/統計情報のデータ構造。

新しいゲームを実装する際は、これらの共通型を継承し、ゲーム固有の状態やアクションを追加します。詳細は`technical-guide-application-architecture.md`を参照してください。

## 5. 実装ガイドライン

新しいゲームをレスポンシブ対応させる、または新しいレスポンシブコンポーネントを作成する際は、以下の原則に従ってください。

-   **`useResponsive`フックを利用する:** レイアウトの分岐は必ずこのフックを基準に行います。
-   **`StyleSheet.create`を使用する:** スタイリングは既存のCSS-in-JSアプローチを踏襲します。
-   **共通コンポーネントを再利用する:** `Button`, `Modal`など、`app/components/ui/`に用意された共通UIコンポーネントを最大限活用します。
-   **タッチフレンドリーな設計:** モバイルでの操作を考慮し、ボタン等のインタラクティブ要素は十分な大きさ（最低44x44px）を確保します。

## 6. テスト戦略

本アーキテクチャの品質を保証するため、以下の4層のテスト戦略を採用します。

### 6.1. ユニットテスト
-   **レスポンシブフック (`useResponsive`):** 画面サイズ変更に応じた`layoutMode`の変化を検証します。
-   **ゲームコントローラー:** `resetGame`などの共通インターフェースの動作を検証します。
-   **レイアウトコンポーネント:** propsに応じた表示切り替えを検証します。

### 6.2. インテグレーションテスト
-   **レイアウト切り替え:** ブラウザリサイズ時の、`GameLayout`とゲームコンポーネント全体の連携動作を検証します。
-   **ゲーム状態の保持:** レイアウト変更（例: PC→モバイル）後もゲームの状態が失われないことを検証します。
-   **モーダル操作:** FABのタップからボトムシートが表示され、内部のボタンが機能するまでの一連の流れを検証します。

### 6.3. ビジュアルリグレッションテスト
-   **PC/モバイル表示:** StorybookやPlaywrightのスナップショットテストを活用し、各デバイスでの主要な表示が崩れていないかを確認します。
-   **アニメーション:** ボトムシートのスライドアニメーションなどが意図通りに動作することを確認します。

### 6.4. E2Eテスト
-   **デバイス切り替え:** Playwrightの機能を使用し、PCとモバイルの各レイアウトで主要なゲームプレイシナリオが完了できることを検証します。

## 7. パフォーマンス考慮事項

快適なユーザー体験を提供するため、以下の点に注意してパフォーマンスを最適化します。

-   **レンダリング最適化:** `useMemo`や`useCallback`を適切に利用し、レスポンシブ状態の変化に伴う不要な再レンダリングを防ぎます。
-   **CSS-in-JS最適化:** スタイルオブジェクトをメモ化し、動的なスタイル変更のコストを最小限に抑えます。
-   **モバイル最適化:** タッチイベント（`onTouchStart`等）のハンドリングを最適化し、アニメーションのパフォーマンスを確保します。
-   **バンドルサイズ:** レスポンシブ関連のコードが過度にバンドルサイズを増加させないよう、適切なコード分割を検討します。

## 8. エラーハンドリング

-   **レスポンシブ検出エラー:** `useResponsive`フックがブラウザAPIを利用できない環境（SSR時など）を考慮し、適切なフォールバック（例: デフォルトでPCレイアウトを返す）を提供します。
-   **UI状態エラー:** モーダルやボトムシートが意図せず重複して表示されることを防ぐ状態管理を行います。また、レイアウト切り替え時にUIの状態（例: スクロール位置）が不自然にリセットされないよう配慮します。

## 9. 将来の拡張シナリオ

本アーキテクチャは、以下の様な将来的な機能拡張を考慮した設計となっています。

-   **リアルタイムゲーム対応:** WebSocketとの連携やリアルタイムでの状態同期。
-   **AI対戦機能:** AIの思考状態の表示や難易度設定。
-   **マルチプレイヤー対応:** 複数プレイヤーの状態管理やターン制御。

## 10. 今後の課題 (Future Work)

このレスポンシブ対応プロジェクトで未完了のタスクは以下の通りです。これらは将来的な改善項目として管理されます。

-   **棒取りゲームのGameController対応:** `useStickTaking`フックの新しいアーキテクチャへの準拠。
-   **ホームページのレスポンシブ対応:** PC/モバイルでのグリッドレイアウト最適化。
-   **UIコンポーネントライブラリの完成:** デザインシステム（色、フォント等）の構築と、`HintOverlay`コンポーネントの実装。
-   **アクセシビリティとタッチ対応の強化:** タッチサイズの徹底、キーボードナビゲーション、スクリーンリーダー対応の強化。
-   **パフォーマンス最適化:** レスポンシブ計算のメモ化、アニメーションの最適化。
-   **テストの拡充:** 各種ユニットテスト、インテグレーションテスト、E2Eテストの網羅率向上。
-   **ブラウザ互換性とアクセシビリティ監査:** 主要ブラウザでの動作確認と、WCAG 2.1 AA準拠のための監査。
-   **ドキュメントの最終調整:** `spec-display.md`の更新など、関連ドキュメントの追従。
