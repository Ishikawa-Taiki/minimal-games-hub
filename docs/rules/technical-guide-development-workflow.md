# 開発ワークフロー (DEVELOPMENT WORKFLOW)

本ドキュメントは、本プロジェクトにおける開発ワークフローやAIの行動規範について定義します。

## 1. ビルドチェックと品質保証

プロジェクトの品質を維持するため、以下のビルドチェックと品質保証に関するルールを遵守しなければなりません。

-   **セットアップ:** 開発環境のセットアップは `npm install` を実行するだけで完了します。E2Eテストに必要なPlaywrightのブラウザなども、このコマンドで自動的にインストールされます。
    **CI環境では、依存関係の厳密な管理のため `npm ci` を使用します。**

-   **ローカルでの事前確認:** 変更をコミットする前に、必ず以下のコマンドを実行し、ビルド、リンティング、型チェック、**およびすべてのテスト**が正常に完了することを確認しなければなりません。
    ```bash
    npm run build
    npm run lint
    npm test
    npm run e2e
    ```
    **ローカルPC、CI環境、Jules開発エージェントなど、異なる環境での動作差異を常に意識してください。**
    特に、Jules開発エージェントのようなヘッドレス環境では、Playwrightのブラウザ起動オプションなど、環境固有の設定が必要になる場合があります。

-   **プッシュ前フック:** `husky` を使用して、リモートリポジトリにプッシュする前に、プロジェクト全体のテスト（ユニットテスト、E2Eテスト）、リンティング、ビルドが自動的に実行されるように設定されています。これにより、品質基準を満たさないコードがリポジトリにプッシュされることを防ぎます。

-   **CI/CD連携:**
    -   **プルリクエストチェック:** GitHub Actionsの `pr-checks.yml` ワークフローにより、プルリクエストが作成または更新されるたびに、テスト、リンティング、ビルドが自動的に実行され、コードの品質が検証されます。
        **このワークフローでは `npm ci` を使用し、依存関係の整合性を保証します。**
    -   **デプロイ:** GitHub Actionsの `deploy.yml` ワークフローにより、`main` ブランチへのマージ後にプロジェクトがビルドされ、GitHub Pagesにデプロイされます。
        **このワークフローでも `npm ci` を使用します。**

## 2. 基本的なワークフロー (Git & PR)

-   **ブランチ:** 新規タスクの開始時、AIは人間の指示に基づき、適切な名前でフィーチャーブランチを作成します。
-   **コミット:** 作業の区切りで、AIは変更内容を要約したコミットメッセージ（日本語）を作成し、人間の承認を得てコミットを実行します。
-   **プッシュ:** AIは人間の指示に基づき、現在のブランチをリモートにプッシュします。
-   **PR提案:** プッシュが完了した後、AIは作業内容を要約したPRのタイトルと本文を自発的に提案します。
-   **言語:** コミットメッセージ、および本プロジェクトで作成されるすべてのドキュメントは、原則として日本語で記述します。

### 2.1. AIの標準作業フロー

AIは、人間からタスクの指示を受けた際、以下の標準作業フローを厳守します。これにより、コードとドキュメントの整合性を保ち、作業の透明性と再現性を確保します。

1.  **タスクの理解と計画:**
    *   ユーザーからの指示を完全に理解します。
    *   関連する既存ドキュメント（技術ガイド、仕様書など）を読み込み、現状と制約を把握します。
    *   作業計画を立てます。この際、コード変更とドキュメント更新の依存関係を明確にします。
    *   疑問点があれば、解決するまで人間（ユーザー）にヒアリングを行うこと。

2.  **ブランチの作成:**
    *   新しいフィーチャーブランチを適切な命名規則で作成します。

3.  **変更の実装とログのリアルタイム更新:**
    *   計画に基づき、コードの変更とドキュメントの更新を並行して進めます。
    *   **重要:** コード変更と関連するドキュメント更新は、常に同じ論理的な単位で完了させます。
    *   **ログのリアルタイム更新:** 作業の進捗や方針変更、重要な決定事項は、会話の区切りごとにリアルタイムでログ（`docs/logs/activities/` および `docs/logs/decisions/`）に整理して記載すること。これにより、コミット時にはログ情報も一緒にコミットされる状態を維持する。

4.  **ローカルでの検証:**
    *   変更が完了したら、`npm test`、`npm run lint`、`npm run build` を実行し、ローカルで全てのチェックがパスすることを確認します。
    *   必要に応じて、手動での動作確認も行います。

5.  **変更のステージングとコミット:**
    *   `git status` を実行し、**現在のブランチが意図したフィーチャーブランチであることを必ず確認します。**
    *   変更されたファイルを `git add` でステージングします。この際、**コミットに含めるべきファイルのみ**を正確にステージングします。一時ファイルや生成ファイルは含めません。
    *   コミットメッセージは、変更内容を明確に記述し、関連するドキュメントの更新も言及します。
    *   コミット後、`.git_commit_message.txt` のような一時ファイルが残っていないか確認し、残っていれば削除します。

6.  **リモートへのプッシュ:**
    *   フィーチャーブランチをリモートリポジトリにプッシュします。

7.  **プルリクエストの作成（提案）と残課題の棚卸し:**
    *   プッシュが完了したら、プルリクエストのタイトルと本文を提案します。
    *   その後、プロジェクトが宿題とすべき残対応がプロンプト中に発生しなかったかをおさらいし、あればIssue化するためのタイトルや本文情報を共有すること。

### 2.2. AIの問題解決フロー

AIは、タスクの実行中やテストの失敗など、予期せぬ問題に直面した場合、以下のフローに従って問題解決を試みます。このフローは、問題の迅速な特定と解決、および過去の知見の活用を目的としています。

1.  **問題の初期分析:**
    *   エラーメッセージ、スタックトレース、テストレポートなどを詳細に確認し、問題の性質（ビルドエラー、テスト失敗、ランタイムエラーなど）と発生箇所を特定します。
    *   問題が特定の環境（例: `pre-push`フック）でのみ発生するかどうかを確認します。

2.  **関連ドキュメントの参照:**
    *   問題の性質に応じて、関連する技術ガイド（例: `technical-guide-development-workflow.md`のテスト関連セクション）を参照し、問題解決のヒントや既存のルールを確認します。

3.  **過去の意思決定ログの調査:**
    *   `docs/logs/decisions/`ディレクトリ内の意思決定ログを調査します。特に、エラーメッセージや問題のキーワードに関連するログを検索し、過去に類似の問題がどのように解決されたか、どのような試行錯誤があったかを確認します。
    *   **検索のヒント:**
        *   エラーメッセージのキーワード
        *   関連するファイル名や機能名
        *   過去のコミットメッセージ
    *   ログから得られた情報に基づき、問題の原因や解決策の仮説を立てます。

4.  **過去の活動ログの調査:**
    *   必要に応じて、`docs/logs/activities/`ディレクトリ内の活動ログを調査し、特定の機能や修正がどのように実装されたか、その過程でどのような問題が発生したかを確認します。

5.  **解決策の検討と実行:**
    *   ドキュメントやログから得られた情報に基づき、問題解決のための具体的なアプローチを検討します。
    *   複数のアプローチが考えられる場合は、それぞれのメリット・デメリットを評価し、最も効果的かつ安全な方法を選択します。
    *   選択したアプローチを実行し、問題が解決したかを確認します。

6.  **問題が解決しない場合:**
    *   上記フローを繰り返しても問題が解決しない場合、または新たな問題が発生した場合は、その時点での状況、試したこと、得られた情報、および次のステップの提案を人間（ユーザー）に報告し、指示を仰ぎます。

7.  **知見のドキュメント化:**
    *   問題が解決した場合、その解決策、試行錯誤の過程、得られた知見を、必要に応じて意思決定ログや技術ガイドに追記し、将来の参照に役立てます。

## 3. テスト実装の方針 (Testing Implementation Policy)

プロジェクトのテストは、CI/CD環境での安定性と迅速なフィードバックを重視し、以下の原則に従う必要があります。

### 3.1. タイムアウトに依存しないアサーション

テスト、特にE2Eテストでは、Playwrightの `expect` が持つ自動リトライ機能によるタイムアウト（デフォルト5000ms）に可能な限り依存しないように実装します。これは、要素の表示や状態の変化を待つことによるテストの不安定化や、CI環境でのエラー検知の遅延を防ぐためです。

**原則として、以下のアプローチを推奨します:**

1.  **値の取得と直接比較:**
    `locator.textContent()` や `locator.inputValue()` などで値を取得します。
2.  **即時評価されるマッチャーの使用:**
    取得した値を `vitest` の `expect(...).toBe(...)` や `expect(...).toEqual(...)` のような、リトライ機能を持たないマッチャーで検証します。

**NG例（タイムアウトに依存）:**
```typescript
// ページのタイトルが「はさみ将棋」であることを期待する（タイムアウトまでリトライし続ける）
const title = page.locator('main h1');
await expect(title).toHaveText('はさみ将棋');
```

**OK例（即時評価）:**
```typescript
// ページのタイトルを取得し、期待値と一致するかを即座に評価する
const titleLocator = page.locator('main h1');
const titleText = await titleLocator.textContent();
expect(titleText).toBe('はさみしょうぎ');
```

この方針により、テストは意図しない状態を即座に検知し、開発サイクルを高速化します。

### 3.2. E2Eテストの責務と実装指針

E2Eテストは、ユーザーの操作を模倣することで、アプリケーション全体の正常性を保証する重要な役割を担います。しかし、その性質上、不安定になりやすく実行時間も長くなる傾向があるため、以下の責務と指針を定めます。

-   **テストの責務分担:**
    -   **ページ遷移のテスト (`tests/navigation.spec.ts`):** ページ間のリンクが正しく設定されていることを検証する責務を持ちます。実際の画面遷移を待つのではなく、リンク要素の`href`属性を検証することを原則とします。これにより、テストの安定性を高め、実行時間を短縮します。
    -   **各ゲームのE2Eテスト (`tests/{game-name}.spec.ts`):** 各ゲームページが直接開かれた状態から、そのページ内でのUI操作（駒を置く、リセットする等）が正しく機能することを検証する責務を持ちます。

-   **`pre-push`フックにおける注意点:**
    -   `git push`時に実行される`pre-push`フックは、開発者のローカル環境（インタラクティブなシェル）と異なる環境で動作する可能性があります。
    -   この環境差異により、特にクライアントサイドのナビゲーションを伴うテストが不安定になる場合があります。
    -   `pre-push`でE2Eテストが失敗し、原因の特定が困難な場合は、安易な待機処理を追加するのではなく、テストの実装方法（アサーションの仕方やテストの責務）そのものを見直すことを検討してください。

## 4. ログ管理

プロジェクトのログ管理に関する詳細は、[ログ管理ドキュメント](./technical-guide-log-management.md)を参照してください。

## 5. 未解決問題と課題の管理

プロジェクトの健全性を維持し、議論中に発生した未解決の問題や将来の課題が失われることを防ぐため、AIは以下の責務を負う。

-   **AIの責務:**
    -   タスクの完了時、またはセッションの終了時、AIはこれまでの議論をレビューし、**未解決の疑問、将来のタスク、または特定されたが即座に対処されなかった問題**がないかを確認しなければならない。
    -   そのような項目が発見された場合、AIは**自発的にGitHub Issueの作成を提案しなければならない。** 提案には、Issueのドラフトタイトルと説明文を含めること。


---
このドキュメントは、プロジェクトの進行に合わせて更新される可能性があります。常に最新の内容を確認してください。
この原則に基づき、常にプロジェクト全体の整合性を保つように努めてください。
---