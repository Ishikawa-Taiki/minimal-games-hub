# 技術ガイド - 開発 (DEVELOPMENT)

本ドキュメントは、プロジェクトのセットアップ、開発ワークフロー、および品質保証に関する規約を定義します。

## 1. 環境構築

### 1.1. 必要なツール
-   **Node.js:** `.node-version` ファイルに指定されたバージョンを使用します (`nodenv`での管理を推奨)。
-   **npm:** Node.jsに同梱されています。

### 1.2. セットアップ手順
1.  **Node.jsのバージョンを合わせる:**
    ```bash
    # プロジェクトで使用するNode.jsバージョンをインストール (nodenvの場合)
    nodenv install
    ```
2.  **依存関係のインストール:**
    プロジェクトのルートディレクトリで、以下のコマンドを実行します。
    ```bash
    npm install
    ```
    *CI環境では、依存関係の厳密な管理のため `npm ci` を使用します。*

### 1.3. 開発サーバーの起動
以下のコマンドを実行すると、`http://localhost:3000` で開発サーバーが起動します。
```bash
npm run dev
```

## 2. 開発ワークフロー

### 2.1. 基本的な流れ (Git & PR)
1.  **ブランチ作成:** 新規タスクの開始時、タスク内容がわかる適切な名前でフィーチャーブランチを作成します。
2.  **実装:** TDDベースの機能追加を推奨します。（詳細は後述）
3.  **ローカルでの検証:** コミット前に、必ず `npm test` と `npm run build` を実行し、全てのチェックが通ることを確認します。
4.  **コミット:** 変更内容を要約した日本語のメッセージでコミットします。
5.  **プッシュ:** フィーチャーブランチをリモートにプッシュします。
6.  **プルリクエスト提案:** プッシュ後、作業内容を要約したプルリクエストを提案します。

### 2.2. TDDベースの機能追加
品質と開発効率の向上のため、以下のTDD（テスト駆動開発）ワークフローを推奨します。

1.  **失敗するテストの記述:** 追加機能の要件を表現する、失敗するテストをまず書きます。
2.  **テストの失敗を確認:** テストを実行し、意図通りに失敗することを確認します。
3.  **最小限のコードを実装:** テストをパスするために必要最小限のコードを実装します。
4.  **テストの成功を確認:** 再度テストを実行し、成功することを確認します。
5.  **リファクタリング:** コードの品質を向上させ、テストが引き続き成功することを確認します。
6.  **繰り返し:** 次の機能単位でこのサイクルを繰り返します。

### 2.3. npmスクリプトの規約
-   **命名規則:** `package.json`のスクリプトは、`動詞:対象`の形式で命名します。（例: `test:unit`, `update:license`）
-   **実行の徹底:** CI/CDやAIエージェントによるタスク実行は、必ず`npm run <script-name>`の形式で行います。パッケージの実行ファイルを直接呼び出してはなりません。

## 3. 品質保証

### 3.1. テスト実装の方針
-   **タイムアウトに依存しないアサーション:** E2Eテストでは、`expect` の自動リトライに可能な限り依存せず、値を取得してから `toBe` や `toEqual` で即時比較することを推奨します。これによりテストの不安定性を減らし、フィードバックを高速化します。
-   **E2Eテストの責務:**
    -   **ページ遷移 (`tests/navigation.spec.ts`):** リンクの`href`属性を検証し、ページ間の接続を保証します。
    -   **各ゲーム (`src/games/[slug]/e2e/*.spec.ts`):** ゲームページ内でのUI操作が正しく機能することを検証します。
-   **テストコード内のコメントアウト:** 将来のテスト実装計画など、重要なコンテキストを含む場合があるため、人間の明確な指示なくして削除してはなりません。

### 3.2. AIの問題解決フロー
AIは、問題に直面した場合、以下のフローに従います。
1.  **初期分析:** エラーメッセージやログを詳細に確認します。
2.  **関連ドキュメントの参照:** 本ガイドなどの関連ドキュメントを参照します。
3.  **過去ログの調査:** `docs/logs/decisions/` や `docs/logs/activities/` を調査し、過去の類似事例を探します。
4.  **解決策の検討と実行:** 得られた情報に基づき、解決策を実行します。
5.  **報告とドキュメント化:** 解決しない場合は人間に報告します。解決した場合は、その知見をログやドキュメントに記録します。

### 3.3. AIの標準作業フロー
AIは、タスク実行時に以下のフローを厳守します。
1.  **タスクの理解と計画:** ユーザーの指示を理解し、関連ドキュメントを読み込み、計画を立てます。
2.  **ブランチの作成**
3.  **実装とログのリアルタイム更新:** コード変更とドキュメント更新を並行して行い、進捗を`docs/logs/`にリアルタイムで記録します。
4.  **ローカルでの検証:** `npm test` と `npm run build` を実行します。
5.  **コミットとプッシュ**
6.  **プルリクエストの作成と残課題の棚卸し:** PRを提案し、議論中に発生した未解決の問題があればIssue化を提案します。

## 4. 技術スタック
-   **フレームワーク:** Next.js
-   **言語:** TypeScript
-   **テスト:** Vitest (ユニット), Playwright (E2E)
-   **リンティング:** ESLint
-   **Node.jsバージョン管理:** `nodenv` (`.node-version` ファイルを参照)
