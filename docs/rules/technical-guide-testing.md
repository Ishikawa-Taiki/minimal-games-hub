# テクニカルガイド: テスト戦略

## 概要

このプロジェクトでは、品質保証のために3層のテスト戦略を採用しています。また、ドキュメントを仕様書として活用する仕様駆動開発 (TDD) を推奨し、テスト・実装・ドキュメントの一貫性を保証します。

## テスト構成

### 1. ユニットテスト (Vitest + @testing-library/react)

**目的**: 個別コンポーネント・フック・コアロジックの単体動作保証

**対象**:
- ゲームコアロジック (`games/*/core.ts`)
- カスタムフック (`games/*/use*.ts`, `hooks/use*.ts`)
- UIコンポーネント (`app/components/**/*.tsx`)

**実行方法**:
```bash
npm run test:unit              # 全ユニットテスト実行
npm run test:unit-ui           # UI付きで実行
npm run test:unit -- <path>    # 特定ファイルのテスト実行
```

**テストファイル命名規則**:
- `*.test.ts` または `*.test.tsx`
- テスト対象ファイルと同じディレクトリに配置

### 2. E2Eテスト (Playwright)

**目的**: 実際のユーザー操作フローの統合動作保証

**対象**:
- ページ全体の動作
- ユーザーインタラクション
- 無効な操作に対するコンソールエラーの検証
- レスポンシブデザイン
- ブラウザ間の互換性

**実行方法**:
```bash
npm run test:e2e               # 全E2Eテスト実行
npm run test:e2e-ui            # UI付きで実行
npm run test:e2e -- <spec>     # 特定specファイルの実行
```

**配置場所と命名規則**:
- **ゲーム固有のテスト:**
  - `src/games/{ゲーム名}/e2e/*.spec.ts`
- **横断的なテスト:**
  - `tests/*.spec.ts`

### 3. 静的解析・品質チェック

**目的**: コード品質とライセンス適合性の保証

**構成**:
- **ESLint**: コード品質・スタイルチェック
- **TypeScript**: 型安全性チェック
- **License Checker**: 依存関係のライセンス確認

**実行方法**:
```bash
npm run test:lint              # ESLint実行
npm run test:license           # ライセンスチェック
npm test                       # 全テスト実行 (上記全てを含む)
```

## 仕様駆動開発 (TDD) による品質保証

ゲームの安定性とデバッグ容易性を向上させるため、特にユーザーによる無効な操作は、仕様書駆動（ドキュメント駆動）のテストファーストアプローチで開発します。

1.  **仕様定義 (`spec-action.md`)**:
    -   各ゲームの`spec-action.md`に、無効な操作の仕様と、その際に期待される`console.error`メッセージを定義します。

    | シナリオ | コンソールエラーメッセージ |
    | :--- | :--- |
    | （具体的な操作シナリオ） | `（期待されるエラーメッセージ）` |

2.  **E2Eテストによる仕様の検証**:
    -   次に、`spec-action.md`を検証するためのE2Eテストを先行実装します。Playwrightの`page.on('console', ...)`を用いて、仕様通りのエラーが出力されることをアサートします。

3.  **コアロジックの実装**:
    - 失敗するE2Eテストを成功させるために、コアロジック(`core.ts`)を実装します。UI層は入力をブロックせず、検証はコアロジック層に委ねます。

この「仕様書 → E2Eテスト → 実装」のサイクルにより、ドキュメント、テスト、実装の一貫性を維持します。

## テスト作成ガイドライン

### 機能別テスト要件

#### 履歴機能のテスト要件
E2Eテストで以下の項目を検証します。
1. **初期状態**: 履歴カウンターが「1 / 1」であり、履歴操作ボタンが無効化されている。
2. **手番実行**: 手番を実行すると、履歴カウンターが更新され、「戻る」ボタンが有効化される。
3. **履歴操作**: 「戻る」「進む」「最初へ」「最後へ」の各機能が正しく動作し、カウンター表示も正確に更新される。
4. **状態復元**: 履歴を移動した際に、盤面・スコア・手番などのゲーム状態が正確に復元される。

#### ヒント機能のテスト (`spec-hint.md`)
**注: 以下の内容は現在実装に反映中です。今後のリファクタリングで適用される方針です。**

ヒント機能のテストは、`spec-hint.md`で定義された各ヒントの動作を個別に保証することを目的とします。

-   **テスト対象**: `spec-hint.md`に記載された、IDを持つ各ヒント機能。
-   **テストの単位**: 各ヒントID（例: `capture-squares`）を1つのテスト単位とします。
-   **テスト内容**: 特定のゲーム状況において、ヒントが仕様書通りに正しく表示・計算されることを検証します。
-   **テストファイルの責務**: ヒント関連のテストは、そのヒントが定義されているゲームのテストファイル内に、IDごとに明確に区別できる形で記述します。

### E2Eテストの安定性

- **`data-testid`属性の使用**: 要素の特定には、テキストやCSSセレクタではなく`data-testid`属性を必ず使用します。
- **待機処理**: アニメーションや非同期処理が原因でテストが不安定になる場合は、`page.waitFor...` 系のAPIを適切に使用し、アプリケーションの状態が安定するのを待ってからアサーションを実行します。
- **デバッグと結果確認**:
  - **スクリーンショット**: 各E2Eテストの実行後、自動的にスクリーンショットが撮影されます。テスト結果の視覚的な確認や、失敗時のデバッグに役立ちます。
    - **保存先**: `test-results/screenshots/[テストファイル名]/` のように、テストファイルごとにディレクトリが作成されます。(このディレクトリはテスト実行前に自動でクリーンアップされます)
    - **ファイル名**: `[結果]-[testId].png` という形式で保存されます。（例: `S-e94210203d247993111f.png`）
      - **結果**: `S`(成功), `F`(失敗), `T`(タイムアウト), `I`(中断), `K`(スキップ) のいずれかで示されます。
      - **testId**: Playwrightが各テスト実行に割り当てるユニークなハッシュ値です。
  - **HTMLレポートとの連携**: `npx playwright show-report test-results/reports` で表示されるHTMLレポートで各テスト項目をクリックすると、そのテストの`testId`を含むURLが表示されます。このIDを使って、対応するスクリーンショットを特定できます。

### テストカバレッジ
- **方針**: 新機能を追加する際は、既存の機能と同等のテストカバレッジを維持することを目標とします。

## CI/CD統合

`husky`によるpre-pushフックで、`npm test`と`npm run build`が自動実行され、品質が保証されます。

## 新機能開発時のテスト要件

- **ゲーム追加時**: コアロジックのユニットテスト、基本操作のE2Eテスト、レスポンシブ対応の確認が必須です。
- **共通コンポーネント/カスタムフック追加時**: 対象のユニットテストと、それを使用する主要箇所でのE2Eテストが必須です。

## テスト環境設定

- **Vitest設定 (`vitest.config.mts`)**: `environment: 'jsdom'` を設定し、ブラウザ環境をエミュレートします。
- **セットアップファイル (`vitest.setup.ts`)**: `@testing-library/jest-dom/matchers` を拡張し、DOMのアサーションマッチャーを使用可能にします。

## トラブルシューティング

- **テストが不安定な場合**: `page.waitForLoadState('networkidle')` などの待機処理を見直します。
- **型エラー**: `as`キーワードなどで適切な型アサーションを行います。

## パフォーマンス考慮事項

- **並列実行**: Playwrightの並列実行を活用し、テスト時間を最適化します。
- **リソース管理**: メモリリーク対策やキャッシュ活用を意識します。

## 参考資料

- [Vitest公式ドキュメント](https://vitest.dev/)
- [Testing Library公式ドキュメント](https://testing-library.com/)
- [Playwright公式ドキュメント](https://playwright.dev/)
