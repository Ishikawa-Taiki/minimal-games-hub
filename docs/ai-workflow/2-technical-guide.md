# 技術ガイド (TECHNICAL GUIDE)

本ドキュメントは、プロジェクトの技術的なルールと規約を定義します。AIは常にこれらのガイドラインを遵守しなければなりません。

---

# 第一部: プロジェクトセットアップ

このセクションでは、開発環境の構築とプロジェクトの実行に必要な技術情報を記載します。

## 1. 環境構築

### Node.jsバージョン管理
本プロジェクトでは、Node.jsのバージョン管理に`nodenv`を使用しています。`.node-version`ファイルに指定されたバージョンを使用してください。

```bash
# プロジェクトで使用するNode.jsバージョンをインストール
nodenv install

# プロジェクトディレクトリでバージョンを有効化
nodenv local
```

### 依存関係のインストール
プロジェクトのルートディレクトリで、以下のコマンドを実行して依存関係をインストールします。

```bash
npm install
```

## 2. 開発サイクル

### 開発サーバーの起動
以下のコマンドを実行すると、`http://localhost:3000` で開発サーバーが起動します。

```bash
npm run dev
```

### ビルド
本プロジェクトは静的サイトとしてエクスポートされます。
以下のコマンドでビルドを実行できます。

```bash
npm run build
```

## 3. 技術スタック
-   **フレームワーク:** Next.js
-   **言語:** TypeScript
-   **スタイリング:** Tailwind CSS (現状維持)

### スタイリングの更新履歴

#### Emotion導入の試みと断念 (2025年8月2日)

Tailwind CSSからの移行としてEmotionの導入を試みましたが、Next.js App Router (v15.4.4) とReact 19 (v19.1.0)、Emotion 11 (`@emotion/react`, `@emotion/styled`) の組み合わせにおいて、ビルド時に `TypeError: f.createContext is not a function` エラーが継続的に発生し、導入を断念しました。

**エラーの根本原因:**
このエラーは、Reactの `createContext` がサーバーサイドのコンポーネント環境で正しく初期化されないことに起因します。Next.js App Routerはデフォルトでサーバーコンポーネントとして動作し、Emotion 11はReact 19の内部的な変更に完全には対応しきれていないため、この問題が発生しました。

**試行した解決策:**
*   EmotionのSSR推奨パターンである「Registry」パターンの導入 (`app/registry.tsx` の作成と `app/layout.tsx` での利用)。
*   Emotionを使用する全てのコンポーネントへの `"use client";` ディレクティブの追加。
*   `tsconfig.json` および `next.config.ts` のEmotion関連設定の有効化。
*   Reactのバージョンを18にダウングレード。

**結論:**
上記の試行にもかかわらずエラーが解消されなかったため、Emotion 11とNext.js App Router + React 19の組み合わせは、現状では安定して動作させることが極めて困難であると判断しました。Emotion 12でReact 19への完全な互換性が期待されていますが、リリース時期は未定です。

**今後の対応:**
本プロジェクトにおけるEmotionの導入は一時的に断念し、既存のTailwind CSSベースの環境を維持します。Emotion 12のリリースやNext.jsのアップデート状況を注視し、将来的に再検討する課題とします。
-   **Node.jsバージョン管理:** `nodenv` (`.node-version` ファイルを参照)
-   **リンティング & フォーマット:** `eslint.config.mjs` に定義されたルールに準拠します。

### スタイリングの優先順位

原則として、コンポーネントのスタイリングにはインラインスタイルを優先的に使用します。

- **理由:** Tailwind CSSのクラス名は、Next.jsの動的インポート（`next/dynamic`）と組み合わせた際に、ビルド時に正しく解析・適用されない場合があります。この問題を回避し、安定した描画を保証するため、インラインスタイルを推奨します。
- **例外:** 全体的なレイアウトや、複数のコンポーネントで共通して利用するスタイルについては、`globals.css` や共通コンポーネントのスタイルシートで定義することを検討します。

## 4. サポート対象環境

本プロジェクトは、以下の環境での動作をサポート対象とします。
特に、**開発および主要な動作確認はGoogle Chromeの最新バージョンで行われます。**

### 4.1. ブラウザ

*   **デスクトップブラウザ:**
    *   Google Chrome: 最新2バージョン
    *   Mozilla Firefox: 最新2バージョン
    *   Microsoft Edge: 最新2バージョン
    *   Apple Safari: 最新2バージョン
*   **モバイルブラウザ:**
    *   iOS 12以降に搭載されるSafari
    *   Android 9以降に搭載されるChrome

### 4.2. オペレーティングシステム (参考)

上記ブラウザが動作する以下のOSバージョンを想定しています。

*   **iOS:** 12.0 以降
*   **Android:** 9.0 以降
*   **Windows:** Windows 10 以降
*   **macOS:** macOS Mojave (10.14) 以降

---

# 第二部: アプリケーション設計

このセクションでは、本アプリケーションの構造と、新しいゲームを追加する際の規約について定義します。

## 4. ゲームの追加方法

新しいゲームを追加する際は、以下の手順に従ってください。

1.  プロジェクトルートの `games/` ディレクトリに、ゲーム用の新しいディレクトリ（例: `games/new-game`）を作成します。
2.  作成したディレクトリ内に、ゲームの実装（Reactコンポーネントなど）と、以下の必須ファイルを配置します。

### 4.1. ディレクトリ構成

各ゲームディレクトリ (`games/[slug]/`) には、最低限以下のファイルを含める必要があります。

```
/games/[slug]/
├── index.tsx         # ゲームのメインコンポーネント
├── manifest.json     # ゲームのメタデータ
├── rules.md          # ゲームのルールを記述したMarkdown
└── spec.md           # ゲームのシステム仕様を記述したMarkdown
```

### 4.2. manifest.json の仕様

`manifest.json` は、ゲームのメタデータを定義するファイルです。`types/game.ts` で定義された `GameManifest` 型に準拠する必要があります。

-   `name` (string): ゲームの正式名称。
-   `path` (string): ゲームページへのパス (例: `/games/tictactoe`)。
-   `rulesFile` (string): `rules.md` へのパス (例: `/games/tictactoe/rules.md`)。
-   `specFile` (string): `spec.md` へのパス (例: `/games/tictactoe/spec.md`)。

## 5. 共通コンポーネント

ゲーム間で共通して利用できるUIコンポーネントを `app/components/` に配置しています。

-   **`GameLayout.tsx`**: 全ゲーム共通のレイアウトを提供します。ゲームタイトル、ルール表示ボタン、ホームへのリンクを含むヘッダーと、ゲーム本体を描画するメイン領域で構成されます。
-   **`MarkdownViewer.tsx`**: Markdown文字列をHTMLに変換して表示するコンポーネントです。

## 6. 型定義

プロジェクト全体で利用する型定義は `types/` ディレクトリに配置します。

-   **`game.ts`**: `GameManifest` など、ゲームに関連する型を定義します。

## 7. ドキュメント標準フォーマット

各ゲームの `rules.md` および `spec.md` は、以下の標準フォーマットに厳密に従う必要があります。

### 7.1. `rules.md` (ゲームルール仕様書 - 想定読者: ユーザー)

```markdown
# [ゲーム名] ルール概要

## 1. ゲームの目的
ゲームの最終的な目標を簡潔に記述します。

## 2. プレイ人数
このゲームをプレイできる人数を記述します。

## 3. ゲームの準備
ゲーム開始前に必要な準備（例: 盤面のセットアップ、初期配置、手番の決定方法など）を記述します。

## 4. プレイ手順
ゲームの基本的な進行（例: ターンの流れ、アクションの種類、駒の動かし方など）をステップバイステップで記述します。

## 5. ゲームの勝敗
ゲームの終了条件と、各プレイヤーの勝敗（勝利、敗北、引き分け）がどのように決定されるかを記述します。

## 6. 用語集 (必要に応じて)
ゲーム固有の専門用語や略語があれば、ここで定義します。
```

### 7.2. `spec.md` (ゲームシステム仕様書 - 想定読者: AIと開発者)

```markdown
# [ゲーム名] システム仕様

## 1. システム概要
このゲームのソフトウェアとしての全体像と、主要な機能について記述します。

## 2. データ構造
ゲームの状態を保持するために使用される主要なデータ構造（例: 盤面データ、プレイヤーデータ、スコアなど）を定義します。

## 3. ユーザーインタラクション
ユーザーからの入力（例: クリック、キーボード操作）がシステムにどのように影響し、どのような結果をもたらすかを記述します。

## 4. ゲームロジック
ゲームの進行、状態遷移、勝敗判定など、コアとなるゲームルールがシステム上でどのように処理されるかを記述します。

## 5. 描画と表示
ゲームの状態がユーザーインターフェースにどのように反映され、表示されるかを記述します。

## 6. エラーハンドリングと例外処理 (必要に応じて)
予期せぬ状況（例: 無効な入力、データ不整合）が発生した場合のシステムの振る舞いを記述します。
```

## 8. ドキュメント更新の運用方針

### 8.1. 新規ゲームへの強制適用

今後作成するすべての新しいゲームの `rules.md` および `spec.md` は、上記の標準フォーマットに厳密に従うことを必須とします。

### 8.2. 既存ゲームへの適用

既存のゲームについては、以下のいずれかのタイミングで、新しい標準フォーマットに更新することを推奨します。

-   **機能追加やバグ修正など、そのゲームに何らかの変更を加える際。** その変更に合わせてドキュメントも更新し、標準フォーマットに合わせます。
-   **ドキュメントの一貫性が特に重要になった場合。** 例えば、新しいAIエージェントを開発する際に、全ゲームの仕様書が統一されている必要がある、といったケース。この場合は、別途「ドキュメントフォーマット統一」のようなタスクを立てて対応します。

### 8.3. ライセンス表記の更新

ライセンス表記ページ (`/license`) の内容は、プロジェクトで使用しているライブラリやアセットに変更があった場合に更新が必要です。
以下の手順で更新を行ってください。

1.  `package.json` や `node_modules` ディレクトリの内容を確認し、使用しているライブラリのリストを最新化します。
2.  各ライブラリのライセンス情報を確認し、`public/licenses.txt` に追記します。
3.  特に、新しいライブラリを追加した場合は、そのライセンスがプロジェクトのライセンス（MIT License）と互換性があるかを確認してください。

## 9. AIの行動規範 (ドキュメント作成時)

ゲーム作成時、AIは `rules.md` および `spec.md` の内容を埋めるために、人間に対して具体的な質問を投げかけ、不明な情報を勝手に記載してはなりません。

## 10. AIの質問に関する行動規範

AIは、人間への質問を生成する際、以下の原則を遵守しなければなりません。

-   **文脈の読み取り:** 提示された情報や過去の対話履歴から読み取れる内容は、最大限に推測し、質問に含めないように努めます。
-   **質問の簡素化:** 冗長な質問や、人間が容易に判断できる内容の質問は避けます。
-   **不明点の明確化:** 文脈から判断できない、または複数の解釈が可能な不明点については、具体的な選択肢を提示するなどして、明確な回答を促す質問を行います。
-   **勝手な判断の禁止:** 不明な情報をAIが勝手に判断して作業を進めることは、いかなる場合も禁止します。必ず人間への確認を優先します。

## 11. ビルドチェックと品質保証

プロジェクトの品質を維持するため、以下のビルドチェックと品質保証に関するルールを遵守しなければなりません。

-   **ローカルでの事前確認:** 変更をコミットする前に、必ず以下のコマンドを実行し、ビルド、リンティング、型チェックが正常に完了することを確認しなければなりません。
    ```bash
    npm run build
    npm run lint
    ```
-   **CI/CD連携:** GitHub ActionsなどのCI/CDパイプラインにビルド、リンティング、型チェックのステップを組み込み、プルリクエストのマージ前に自動的に品質が検証されるようにします。

---

# 第三部: アプリケーション設計

このセクションでは、本アプリケーションの構造と、新しいゲームを追加する際の規約について定義します。

## 12. 基本的なワークフロー (Git & PR)

-   **ブランチ:** 新規タスクの開始時、AIは人間の指示に基づき、適切な名前でフィーチャーブランチを作成します。
-   **コミット:** 作業の区切りで、AIは変更内容を要約したコミットメッセージ（日本語）を作成し、人間の承認を得てコミットを実行します。
-   **プッシュ:** AIは人間の指示に基づき、現在のブランチをリモートにプッシュします。
-   **PR提案:** プッシュが完了した後、AIは作業内容を要約したPRのタイトルと本文を自発的に提案します。
-   **言語:** コミットメッセージ、および本プロジェクトで作成されるすべてのドキュメントは、原則として日本語で記述します。

## 13. セッション管理

本プロジェクトは `docs/ai-workflow/3-session-context.md` を単一エントリーポイントとします。AIは以下の責務を負います。

1.  **コンテキストの参照:** セッション開始時、AIはまず`docs/ai-workflow/3-session-context.md`を読み込み、現状を把握します。詳細情報が必要な場合は、そこからポインタをたどって各ドキュメントを参照します。
2.  **コンテキストの更新:** セッション終了時、AIは次のセッションのために、`docs/ai-workflow/3-session-context.md`を最新の作業状況で更新し、コミットに含めます。

## 14. ログの管理と責務

プロジェクトの透明性と再現性を確保するため、「議事録」と「作業ログ」の2種類のログを管理します。

-   **`docs/project-info/setup-log.md` (議事録):**
    -   **目的:** **なぜ**その決定をしたのか、という**理由**と**背景**を記録する。
    -   **内容:** 設計上のトレードオフ、導入技術の選定理由、ワークフローの変更理由など、将来参照すべきハイレベルな意思決定を記録する。
    -   **AIの責務:** 重要な意思決定が行われたセッションの最後に、その内容を要約し、追記を自発的に提案しなければならない。

-   **`docs/ai-workflow/logs/` (作業ログ):**
    -   **目的:** **なにを**したのか、という具体的な**作業の事実**を時系列で記録する。
    -   **内容:** `system.log`にはプロジェクト全体に関わる作業を、`games/(ゲーム名).log`には特定のゲームに関する作業を記録する。
    -   **AIの責務:** 作業を行った**すべてのセッションの最後**に、その日の作業内容のサマリーを適切なログファイルに追記しなければならない。

-   **ログ追記の厳格な手順:**
    -   ログファイルへの追記を行う際、AIは**必ず**以下の手順を実行しなければならない。ファイルの直接的な上書きによる情報損失は、重大なルール違反とみなす。
        1.  `read_file` で対象ファイルの現在の全内容を読み込む。
        2.  読み込んだ内容の末尾に、新しく記録する内容を文字列として結合する。
        3.  `write_file` を使用し、結合後の文字列でファイル全体を上書きする。

## 15. ドキュメントの所有権と更新責務

各ドキュメントの更新責任は、以下の通り明確に定義されます。

---

#### `README.md`

-   **目的:** プロジェクトの全体像を伝える「顔」。
-   **人間の責務:**
    -   AIから提案された更新内容をレビューし、承認または却下する。
-   **AIの責務:**
    -   開発手順、ビルド方法、デプロイ先、プロジェクトのコンセプトなど、**ゲームのリスト以外の**全体像に影響を与える変更が発生した場合、**セッションの最後に必ず`README.md`の更新が必要か判断し、具体的な変更案を自発的に提案しなければならない。**

---

#### `docs/project-info/human-guide.md` (人間向けガイド)

-   **目的:** 人間がAIとの協業をスムーズに進めるための手引書。
-   **人間の責務:**
    -   AIとの対話方法やワークフローの変更を望む場合、その旨をAIに伝える。
-   **AIの責務:**
    -   人間との対話方法やワークフローに関する変更が議論され合意された場合、**自発的にこのガイドの更新案を提案しなければならない。**

---

#### `docs/ai-workflow/1-project-manifest.md` (憲法)

-   **目的:** プロジェクトの不変の基本理念。
-   **人間の責務:**
    -   **このドキュメントの変更を開始できる唯一の存在である。**
-   **AIの責務:**
    -   人間からの明確な指示があった場合に**のみ**、変更作業を実行する。自発的な変更提案は一切行ってはならない。

---

#### `docs/ai-workflow/2-technical-guide.md` (技術ガイド)

-   **目的:** AIと人間の協業ワークフローを定義する「法律」。
-   **人間の責務:**
    -   ワークフローの変更を望む場合、AIに対してこのドキュメントの更新を指示する。
    -   AIから提案されたルールの更新案をレビューし、承認する。
-   **AIの責務:**
    -   ワークフローに関する新しいルールが議論され合意に至った場合、**その内容を反映させるため、自発的にこのドキュメントの更新を提案しなければならない。**

---

#### `docs/ai-workflow/3-session-context.md` (セッションコンテキスト)

-   **目的:** 短期的な作業記憶。
-   **人間の責務:**
    -   セッション開始時に、`human-guide.md`に記載されたフォーマットに従って、`## 本日の指示`を含むプロンプトを送信する。
-   **AIの責務:**
    -   **このドキュメントの完全な管理責任を負う。**
    -   人間からの開始プロンプトを受け取った際、**直ちに`## 本日の指示`の内容をこのファイルの「現在のタスク」セクションに転記し、タスクを開始しなければならない。**
    -   セッション終了時には必ず最新の状況（ブランチ、進捗）を反映した上でコミットに含めなければならない。

---

#### `docs/project-info/setup-log.md` (セットアップログ)

-   **目的:** プロジェクトの重要な意思決定を記録する「議事録」。
-   **人間の責務:**
    -   AIが提案した議事録の内容をレビューし、正確性を保証する。
-   **AIの責務:**
    -   以下のトピックに関する議論や意思決定が行われた場合、**その議論の背景、選択肢、結論を要約し、ログへの追記を自発的に提案しなければならない。**
        1.  **プロジェクト全体の構造やアーキテクチャに関する変更**
        2.  **開発ワークフロー、ドキュメントルールなど、運用設計に関する変更**
        3.  新しい技術（ライブラリ、ツール等）の導入や設定変更
        4.  その他、将来の参照価値が高いと判断される技術的な課題解決

---

#### 各ゲームの仕様書 (`games/[slug]/*.md`)

-   **目的:** ゲームの動作を定義する「設計図」。
-   **人間の責務:**
    -   新しいゲームの初期仕様を定義する。
    -   AIから提案された仕様変更をレビューし、承認する。
-   **AIの責務:**
    -   実装に着手する前、**必ず関連する仕様書をすべて読み込まなければならない。**
    -   人間からの指示が既存の仕様と矛盾する場合、または仕様に定義されていない場合、**コードを記述する前に、まず仕様書の変更案を提示し、人間の承認を得なければならない。**

---

## 16. ルールと仕様の参照

-   **ゲーム仕様:** ゲームの実装や修正を開始する前に、AIは必ず対象ゲームのディレクトリ（`games/[slug]/`）に定義された仕様を最初に読み込み、完全に理解しなければなりません。
-   **新規ゲーム開発:** 新しいゲームを開発する際は、まずルールとシステム仕様に関するドキュメントを作成し、人間の承認を得てから実装を開始します。

## 17. ルールの整合性維持

-   AIは、新しいルールを追加・変更する際、既存ルールとの整合性をチェックリストに基づき自己検証し、必要であれば統合・修正案を同時に提案しなければなりません。

## 18. AIの初期行動

人間から新しいタスクの指示を受けた際、AIは具体的な作業に入る前に、必ず関連するワークフロー（特にGitワークフローとドキュメント更新責務）を確認し、その旨を宣言します。

## 19. ドキュメントスタイル規約

本プロジェクトのすべてのドキュメントは、以下のスタイル規約を遵守すること。

-   **文体:** 原則として「敬体（です・ます調）」を使用する。
-   **用語:** プロジェクト内で使用する専門用語は統一し、一貫性を持たせる。
-   **既存ドキュメントの編集:** ドキュメントを編集する際、AIは**必ず**既存の書式（見出しレベル、リスト形式、強調表現など）と文体を分析し、そのスタイルに厳密に従わなければならない。新しいセクションを追加する場合も、そのドキュメントの既存の構造に倣うこと。

## 20. 未解決問題と課題の管理

プロジェクトの健全性を維持し、議論中に発生した未解決の問題や将来の課題が失われることを防ぐため、AIは以下の責務を負う。

-   **AIの責務:**
    -   タスクの完了時、またはセッションの終了時、AIはこれまでの議論をレビューし、**未解決の疑問、将来のタスク、または特定されたが即座に対処されなかった問題**がないかを確認しなければならない。
    -   そのような項目が発見された場合、AIは**自発的にGitHub Issueの作成を提案しなければならない。** 提案には、Issueのドラフトタイトルと説明文を含めること。

### 8.3. ライセンス表記の更新

ライセンス表記ページ (`/license`) の内容は、プロジェクトで使用しているライブラリやアセットに変更があった場合に更新が必要です。
以下の手順で更新を行ってください。

1.  `package.json` や `node_modules` ディレクトリの内容を確認し、使用しているライブラリのリストを最新化します。
2.  各ライブラリのライセンス情報を確認し、`public/licenses.txt` に追記します。
3.  特に、新しいライブラリを追加した場合は、そのライセンスがプロジェクトのライセンス（MIT License）と互換性があるかを確認してください。
