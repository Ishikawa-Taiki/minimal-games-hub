# 神経衰弱 システム動作仕様

## 1. ゲームの状態管理
システムは、ゲームを正しく進行させるために、以下の情報を常に記憶・管理します。

- **難易度:** `'easy'`, `'normal'`, `'hard'` のいずれか。
- **カードの状態:** 場に並べられた各カードが、「裏向き」「表向き」「マッチ済み」のいずれの状態にあるか。また、どのプレイヤーにマッチされたかも記録します。
- **一時的に表向きのカード:** 現在のターンで表向きにされたカード（0枚、1枚、または2枚）の情報。
- **手番:** 現在、どちらのプレイヤー (`'player1'` または `'player2'`) の手番であるか。
- **スコア:** 各プレイヤーが獲得したペアの数。
- **ゲーム状況:** ゲームが「プレイ前」「プレイ中」「結果表示中」のいずれの状態にあるか。

## 2. ゲームの初期化
ゲームが開始される（またはリセット、難易度変更される）際、システムは状態を以下のように設定します。

1.  **デッキの生成:** 選択された難易度に応じて、以下のカードセットを生成します。
    - **easy:** 2スート x 10ランク = 20枚
    - **normal:** 4スート x 10ランク = 40枚
    - **hard:** 4スート x 13ランク + ジョーカー2枚 = 54枚
2.  **シャッフル:** 生成したデッキをランダムにシャッフルし、場の各位置にカードを割り当てます。
3.  **状態の初期化:**
    -   すべてのカードの状態を「裏向き」にします。
    -   両プレイヤーのスコアを0にします。
    -   手番を `'player1'` に設定します。
    -   ゲーム状況を「プレイ中」にします。

## 3. プレイヤーの操作と状態遷移
プレイヤーが裏向きのカードを1枚選択した際、システムは以下の手順で処理を実行します。

1.  **操作の検証:**
    -   ゲーム状況が「プレイ中」であること。
    -   現在、一時的に表向きになっているカードが2枚未満であること。
    -   選択されたカードの状態が「裏向き」であること。
    -   上記の条件が満たされない場合、以降の処理は行いません。
2.  **カードを表向きにする:**
    -   検証を通過した場合、選択されたカードの状態を「表向き」にし、「一時的に表向きのカード」として記録します。
3.  **ペアの判定（表向きカードが2枚になった場合）:**
    -   一時的に表向きのカードが2枚になった時点で、ペアが成立したか判定します。
    -   **ペアが成立した場合:**
        1.  現在の手番プレイヤーのスコアを1加算します。
        2.  2枚のカードの状態を「マッチ済み」に変更し、所有者情報を記録します。
        3.  一時的に表向きのカードの記録をクリアします。
        4.  手番は交代せず、同じプレイヤーが続けて操作できます。
        5.  全カードが「マッチ済み」になった場合、ゲーム状況を「結果表示中」に遷移させます。
    -   **ペアが不成立の場合:**
        1.  システムは、2枚のカードを一定時間（例: 1.2秒）表示させた後、状態を「裏向き」に戻します。
        2.  一時的に表向きのカードの記録をクリアします。
        3.  手番を相手プレイヤーに交代します。

## 4. 不正な操作への対応
プレイヤーがルール上許可されていない操作を行った場合、システムはその操作を無視し、ゲームの状態は一切変更されません。
- **例:**
  - 「マッチ済み」のカードを選択する。
  - 自分の手番ではないときにカードを選択する。
  - 2枚のカードが評価中のタイミングで、さらに別のカードを選択する。

---
## 本資料で定義すべきこと
- ペア不成立時にカードを表示させておく時間の正確な秒数。現在の実装では `1200` ミリ秒に設定されていますが、これはゲームのUXに関わる重要な値であるため、仕様として明記することが望ましいです。
