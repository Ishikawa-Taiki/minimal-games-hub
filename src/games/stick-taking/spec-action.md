# 棒取りゲーム システム動作仕様

## 1. ゲームの状態管理
システムは、ゲームを正しく進行させるために、以下の情報を常に記憶・管理します。

- **難易度:** ゲームの難易度 (`'easy'`, `'normal'`, `'hard'`)。
- **各列の棒の状態:** 各列に配置された棒が、それぞれ「未取得」「取得済み」のいずれであるか。
- **手番:** 現在、どちらのプレイヤー (`'プレイヤー1'` または `'プレイヤー2'`) の手番であるか。
- **選択中の棒:** 現在のターンでプレイヤーが選択している棒の情報。
- **ゲーム状況:** ゲームが「プレイ中」または「終了」のいずれの状態にあるか。
- **勝者:** ゲームが終了した場合、どちらのプレイヤーが勝利したか。

## 2. ゲームの初期化
プレイヤーが難易度を選択してゲームを開始すると、システムは状態を以下のように設定します。

-   難易度に応じた本数の棒を各列に配置し、すべてを「未取得」状態にします。
-   手番を `'プレイヤー1'` に設定します。
-   ゲーム状況を「プレイ中」にします。
-   選択中の棒の情報を空にします。

## 3. プレイヤーの操作と状態遷移
### 3.1. 棒の選択
プレイヤーがまだ取得されていない棒をクリックした際、システムは以下のルールに従ってその棒を「選択中」の状態にします。

-   **単一選択:** クリックされた棒を新たに選択します。
-   **連続選択:** 既に選択中の棒に隣接する棒がクリックされた場合、その棒を選択範囲に追加します。
-   **選択解除:** 選択範囲の端にある棒が再度クリックされた場合、その棒の選択を解除します。
-   **非連続選択:** 選択中の棒と隣接しない棒がクリックされた場合、既存の選択をすべて解除し、新たにクリックされた棒のみを選択します。

### 3.2. 棒を取る
プレイヤーが「棒を取る」ボタンを押した際、システムは以下の手順で処理を実行します。

1.  **操作の検証:**
    -   1本以上の棒が「選択中」であることを確認します。
2.  **状態の更新:**
    -   検証を通過した場合、「選択中」のすべての棒の状態を「取得済み」に変更します。
3.  **勝利判定:**
    -   フィールドに残っている棒が0本になった場合、**最後に棒を取ったプレイヤーの相手**を勝者とし、ゲーム状況を「終了」に設定します。
4.  **手番の交代:**
    -   勝利が確定しなかった場合、手番を相手プレイヤーに交代します。

## 4. 無効な操作とコンソールエラー
プレイヤーがルール上許可されていない操作を行った場合、システムはその操作を無視してゲームの状態を変更せず、開発者コンソールにエラーメッセージを出力します。

| シナリオ | コンソールエラーメッセージ |
| :--- | :--- |
| 1本も棒を選択せずに「棒を取る」ボタンを押す | `Invalid action: Cannot take 0 sticks.` |
| 既に取得済みの棒をクリックする | `Invalid action: Stick at row <rowIndex>, id <stickId> has already been taken.` |
| （内部的なエラー）存在しないはずの棒IDが指定される | `Invalid action: Stick with id <stickId> at row <rowIndex> does not exist.` |
