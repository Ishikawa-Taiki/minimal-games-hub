# ドット＆ボックス システム動作仕様

## 1. ゲームの状態管理
システムは、ゲームを正しく進行させるために以下の情報を常に記憶し、管理します。

-   **難易度:** プレイヤーが選択した難易度（かんたん, ふつう, むずかしい）。
-   **盤面のサイズ:** 難易度に応じたドットの行列数。
-   **ラインの状態:** 全ての水平・垂直ラインが、いずれかのプレイヤーによって引かれたか、まだ引かれていないかの状態。
-   **ボックスの状態:** 全てのボックスが、いずれかのプレイヤーによって獲得されたか、まだ未獲得かの状態。
-   **現在のプレイヤー:** 現在手番のプレイヤー（プレイヤー1またはプレイヤー2）。
-   **各プレイヤーのスコア:** 各プレイヤーが獲得したボックスの総数。
-   **ゲームの進行状況:** 「難易度選択待ち」「プレイ中」「終了」のいずれか。
-   **プレビュー中のライン:** 「おしえて！」機能が有効な場合に、プレイヤーがプレビュー対象として選択しているラインの情報。プレビュー中でなければ、この情報は空です。

## 2. ゲームの初期化
プレイヤーが難易度を選択してゲームを開始した際、システムは以下の状態になります。

-   選択された難易度に基づき、盤面のサイズ、ライン、ボックスを生成し、初期状態に設定します。
-   全てのラインは「未選択」の状態になります。
-   全てのボックスは「未獲得」の状態になります。
-   現在のプレイヤーを「プレイヤー1」に設定します。
-   両プレイヤーのスコアを「0」に設定します。
-   ゲームの進行状況を「プレイ中」に更新します。
-   プレビュー中のライン情報を空にします。

## 3. プレイヤーの操作と状態遷移
プレイヤーがまだ引かれていないラインを1つ選択した場合、システムは以下の処理を順に行います。

1.  **ラインの更新:** 選択されたラインを、現在のプレイヤーが引いたものとして状態を更新します。
2.  **ボックス完成の判定:** 新しく引かれたラインによって、1つまたは2つのボックスが完成したかを判定します。
3.  **状態遷移の分岐:**
    -   **ボックスが完成した場合:**
        a. 完成した全てのボックスを、現在のプレイヤーが獲得したものとして状態を更新します。
        b. 獲得したボックスの数だけ、現在のプレイヤーのスコアを加算します。
        c. 手番は交代せず、現在のプレイヤーが続けてラインを引ける状態を維持します。
        d. ゲームの終了条件（後述）を満たしているかを確認します。
    -   **ボックスが完成しなかった場合:**
        a. 手番を相手プレイヤーに交代します。

## 4. ゲームの進行ルール
- **ゲームの終了:** 盤上の全てのラインが引かれた時点で、ゲームは自動的に終了し、進行状況が「終了」に更新されます。システムは最終スコアを比較し、勝者を決定します（スコアが多い方が勝ち、同数の場合は引き分け）。
- **ゲームのリセット:** ゲーム終了後に表示される結果ダイアログを閉じる、またはコントロールパネルの「リセット」ボタンが操作されると、ゲームの状態は完全に初期化され、「難易度選択待ち」の状態に戻ります。

## 5. 「おしえて！」機能利用時の操作
「おしえて！」機能が有効な時、プレイヤーがまだ引かれていないラインを1回選択した場合、システムは以下の処理を行います。

1.  そのラインを「プレビュー中のライン」として記憶します。この時点では、手番やスコアなどのゲーム状態はまだ変化しません。
2.  プレイヤーが同じ「プレビュー中のライン」を再度選択した場合、上記「3. プレイヤーの操作と状態遷移」の処理を実行し、手を確定させます。
3.  プレイヤーが別のラインを選択した場合、「プレビュー中のライン」の情報を新しく選択されたラインに更新します。

## 6. 無効な操作とコンソールエラー
プレイヤーがルール上許可されていない操作を行った場合、システムはその操作を無視してゲームの状態を変更せず、開発者コンソールにエラーメッセージを出力します。

| シナリオ | コンソールエラーメッセージ |
| :--- | :--- |
| 既に引かれている辺（ライン）を再度クリックする | `Invalid action: Line (<type>, <r>, <c>) has already been selected.` |