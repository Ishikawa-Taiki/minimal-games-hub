# ドット＆ボックス システム動作仕様

## 1. ゲームの状態管理
システムは、ゲームを正しく進行させるために以下の情報を常に記憶し、管理します。

-   **難易度 (Difficulty):** ユーザーが選択した難易度（かんたん、ふつう、むずかしい）。これによりボードのサイズが決まります。
-   **ボードのサイズ (Board Size):** 難易度に応じたドットの数（例: 「かんたん」なら3x3）。
-   **水平ラインの状態 (Horizontal Lines):** 各水平ラインが、どのプレイヤーによって引かれたか、あるいはまだ引かれていないかの状態。
-   **垂直ラインの状態 (Vertical Lines):** 各垂直ラインが、どのプレイヤーによって引かれたか、あるいはまだ引かれていないかの状態。
-   **ボックスの状態 (Boxes):** 各ボックス（マス）が、どのプレイヤーによって獲得されたか、あるいはまだ誰のものでもないかの状態。
-   **現在のプレイヤー (Current Player):** 現在手番のプレイヤー（プレイヤー1またはプレイヤー2）。
-   **スコア (Scores):** 各プレイヤーが獲得したボックスの数。
-   **ゲームステータス (Game Status):** ゲームの進行状況（難易度選択待ち、プレイ中、終了）。
-   **プレビュー中のライン (Preview Line):** プレビュー機能で選択されているラインの情報。プレビュー中でなければ空。

## 2. ゲームの初期化
プレイヤーが難易度を選択してゲームを開始した際、システムは以下の状態になります。

-   選択された難易度に応じて、ボードのサイズ、ライン、ボックスを初期化する。
-   すべてのラインは「未選択」状態になる。
-   すべてのボックスは「未獲得」状態になる。
-   現在のプレイヤーは「プレイヤー1」に設定される。
-   両プレイヤーのスコアは「0」にリセットされる。
-   ゲームステータスは「プレイ中」になる。
-   プレビュー中のラインは空になる。

## 3. プレイヤーの操作と状態遷移
プレイヤーがラインを1つ選択した（クリック/タップした）場合、システムは以下の処理を順に行います。

1.  **有効性の検証:**
    -   選択されたラインが既に引かれている場合、操作を無視し、何も状態は変化しない。
    -   選択されたラインがまだ引かれていない場合、次の処理へ進む。

2.  **ラインの更新:**
    -   選択されたラインを「現在のプレイヤー」が引いたものとして状態を更新する。

3.  **ボックス完成の判定:**
    -   新しく引かれたラインによって、1つまたは2つのボックスが完成したか（四方がすべて埋まったか）を判定する。

4.  **状態遷移の分岐:**
    -   **ボックスが完成した場合:**
        a.  完成したすべてのボックス（1つまたは2つ）の状態を「現在のプレイヤー」が獲得したものとして更新する。
        b.  獲得したボックスの数だけ、現在のプレイヤーのスコアを加算する。
        c.  **手番は交代せず**、現在のプレイヤーが続けてラインを引ける状態を維持する。
        d.  ゲーム終了の判定（後述）を行う。

    -   **ボックスが完成しなかった場合:**
        a.  手番を相手プレイヤーに交代する。

## 4. プレビュー機能の操作
「おしえて！」機能がオンの時、プレイヤーがまだ引かれていないラインを1回選択した場合：

1.  システムはそのラインを「プレビュー中のライン」として記憶する。
2.  ゲームの状態（手番、スコアなど）はまだ変化しない。
3.  プレイヤーが同じ「プレビュー中のライン」を再度選択した場合、「3. プレイヤーの操作と状態遷移」の処理を実行する。
4.  プレイヤーが別のラインを選択した場合、「プレビュー中のライン」を新しく選択されたラインに更新する。

## 5. ゲームの終了判定
いずれかのプレイヤーがラインを引くたびに、システムは以下の終了条件を確認します。

-   **終了条件:** ボード上のすべてのライン（水平・垂直）が引かれた場合。
-   **終了処理:**
    -   ゲームステータスを「終了」に更新する。
    -   最終的なスコアを比較し、勝者を決定する（スコアが多い方が勝ち。同数の場合は引き分け）。

## 6. コントロールパネルのアクション

### 6.1. リセット
-   **アクション**: ユーザーがコントロールパネル内の「リセット」ボタンをクリックします。
-   **状態遷移**:
    -   `resetGame`アクションがディスパッチされます。
    -   ゲームの状態が完全に初期化され、`status`が`'waiting'`に戻り、難易度選択画面が表示されます。

## 7. ダイアログのアクション

### 7.1. リザルトダイアログ
-   **トリガー**: ゲーム終了時に自動的に表示されます。
-   **アクション**: ユーザーが表示されたリザルトダイアログの「OK」ボタンをクリックします。
-   **状態遷移**:
    -   ダイアログが閉じられます。
    -   `resetGame`アクションが実行され、難易度選択画面に戻ります。

## 8. 不正な操作への対応
-   ルール上許可されていない操作（例: すでに引かれたラインの選択）が行われた場合、システムはそれを完全に無視し、ゲームの状態は一切変更されません。ユーザーへのエラーメッセージ表示なども行いません。