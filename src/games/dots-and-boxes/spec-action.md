# アクション仕様書: ドット＆ボックス

本ドキュメントは、「ドット＆ボックス」ゲームにおけるユーザーのアクションと、それに対応するシステムの動作仕様を定義します。

## 1. ゲームの開始と難易度選択

1.  ユーザーがトップページから「ドット＆ボックス」を選択すると、難易度選択画面が表示されます。
2.  ユーザーが「かんたん」「ふつう」「むずかしい」のいずれかのボタンをクリックします。
3.  システムは選択された難易度（盤面のサイズ）でゲームを初期化し、ゲーム画面に遷移します。
4.  最初のターンはプレイヤー1から始まります。

## 2. ゲーム中のアクション

### 2.1. ラインの選択とターンの進行

本ゲームのライン選択は、プレビュー機能を実現するため、2段階のクリック方式を採用します。これは「リバーシ」のプレビュー機能の動作に準拠します。

#### 正常な操作フロー

1.  **プレビュー表示 (1回目のクリック):**
    -   ユーザーがまだ引かれていない、選択可能なラインを1回クリックします。
    -   システムは、その手を選択した場合の結果をプレビュー表示します（詳細は `spec-display.md` を参照）。
        -   獲得できるボックスがあればハイライトします。
        -   隣接するマスの「残りライン数」が変化する場合は、その数字の色を変えて表示します。
    -   この時点では、まだ手は確定しておらず、ターンも進行しません。

2.  **手の確定 (2回目のクリック):**
    -   ユーザーが、プレビュー表示されているのと同じラインを再度クリックします。
    -   システムは、その手を確定します。
        -   ラインを現在のプレイヤーの色で描画します。
        -   プレビュー表示は解除されます。
    -   システムは、その手によってボックスが完成したか判定します。

#### プレビュー対象の切り替え

-   あるラインをプレビュー表示中に、ユーザーが別の選択可能なラインをクリックした場合、システムは新しいラインのプレビューに表示を切り替えます。最初に対象としたラインのプレビューは解除されます。

### 2.2. ボックスの獲得と追加ターン

1.  **ボックスの判定:**
    -   手が確定した後、システムは引かれたラインが1つまたは複数のボックスの4辺目を完成させたかどうかを判定します。
2.  **ボックスの獲得:**
    -   完成したボックスがあった場合、システムはそのボックスを現在のプレイヤーの陣地として記録し、`spec-display.md` に基づいて盤面を更新（色を塗るなど）します。
    -   スコア（獲得ボックス数）を更新します。
3.  **追加ターンの発生:**
    -   ボックスを1つでも獲得した場合、現在のプレイヤーは続けてもう一度、線を引く権利を得ます。ターンは交代しません。
    -   プレイヤーは再び「2.1. ラインの選択」のフローに従って操作を行います。

### 2.3. ターンの交代

-   手が確定した後、ボックスが1つも完成しなかった場合、システムはターンを相手プレイヤーに交代させます。
-   ステータス表示が更新され、次のプレイヤーのターンであることが示されます。

## 3. ゲームの終了

1.  **終了条件:**
    -   盤面のすべてのラインが引かれた時点で、ゲームは自動的に終了します。
2.  **結果の表示:**
    -   システムは、各プレイヤーが獲得したボックスの総数を比較し、勝敗を判定します。
    -   `spec-display.md` で定義された勝敗結果ダイアログを表示します。

## 4. コントロール機能

`GameLayout`コンポーネントによって提供される共通のコントロール機能が適用されます。

-   **もう一回遊ぶ (リセット):**
    -   ユーザーが勝敗結果ダイアログの「もう一回遊ぶ」ボタン、またはコントロールパネルのリセットボタンをクリックします。
    -   システムは、現在の難易度設定を維持したまま、ゲームの状態（盤面、スコア、ターンなど）をすべて初期状態に戻します。
-   **トップに戻る:**
    -   ユーザーが勝敗結果ダイアログまたはコントロールパネルの「トップに戻る」ボタンをクリックします。
    -   システムはトップページに遷移します。
-   **おしえて！ (ヒント機能):**
    -   ユーザーがコントロールパネルの「おしえて！」スイッチをON/OFFします。
    -   **ONの場合:** `spec-hint.md` で定義されたヒント機能が有効になります。
    -   **OFFの場合:** ヒント表示はすべて無効になります。
    -   この設定はゲーム中にいつでも切り替え可能です。