# アニマルチェス システム動作仕様

## 1. ゲームの状態管理
システムは、ゲームを正しく進行させるために、以下の情報を常に記憶・管理します。

- **盤面の状態:** 3x4の各マスに、どのコマが存在するか、または空か。コマは `{ type: PieceType, owner: Player }` という形式で管理されます。
  - `PieceType`: 'LION', 'GIRAFFE', 'ELEPHANT', 'CHICK', 'ROOSTER' のいずれか。
  - `Player`: 'OKASHI' (おかしチーム) または 'OHANA' (おはなチーム) のいずれか。
- **持ちコマ:** 各プレイヤー (`OKASHI`, `OHANA`) が、どの種類のコマ(`PieceType`)を配列として保持しているか。
- **手番:** 現在、どちらのプレイヤー (`OKASHI` または `OHANA`) の手番であるか。
- **ゲーム状況:** ゲームが「プレイ中」または「勝利」のいずれの状態にあるか。
- **勝者と理由:** 勝利が確定した場合、どちらのプレイヤーが、どの理由（キャッチまたはトライ）で勝利したか。

## 2. ゲームの初期化
ゲームが開始される（またはリセットされる）際、システムは状態を以下のように設定します。

- **盤面の状態:** ルールで定められた初期配置にコマをセットします。
- **持ちコマ:** 両プレイヤーの持ちコマリストを空の状態にします。
- **手番:** 先手である `'OKASHI'` に設定します。
- **ゲーム状況:** 「プレイ中」に設定します。

## 3. プレイヤーの操作と状態遷移
プレイヤーの操作は、「盤上のコマを動かす」または「持ちコマを打つ」の2種類です。システムはプレイヤーの入力（例：マスの選択）に応じて、これらの操作を解釈し、状態を遷移させます。

### 3.1. 盤上のコマを動かす
1.  **操作の検証:**
    -   選択されたコマが、現在の手番プレイヤーのものであることを確認します。
    -   移動先のマスが、そのコマのルール上有効な移動先であることを確認します。
2.  **盤面の更新:**
    -   検証を通過した場合、コマを選択元のマスから移動先のマスへ動かします。
    -   移動先に相手のコマがいた場合、そのコマを盤上から取り除き、現在の手番プレイヤーの持ちコマに加えます。「ニワトリ」を捕獲した場合、持ちコマとしては「ヒヨコ」として加えます。
3.  **「成り」の処理:**
    -   移動したコマが「ヒヨコ」であり、かつ移動先が相手陣地の最終ラインであった場合、そのコマを「ニワトリ」に成らせます。
4.  **勝利判定:**
    -   盤面の更新後、勝利条件が満たされたかを確認します。
    -   **キャッチ:** 相手の「ライオン」を捕獲した場合。
    -   **トライ:** 自分の「ライオン」が相手陣地の最終ラインに到達した場合。
    -   いずれかの条件が満たされた場合、ゲーム状況を「勝利」とし、勝者と勝利理由を記録します。
5.  **手番の交代:**
    -   勝利が確定しなかった場合、手番を相手プレイヤーに交代します。

### 3.2. 持ちコマを打つ
1.  **操作の検証:**
    -   選択された持ちコマが、現在の手番プレイヤーのものであることを確認します。
    -   配置先のマスが、盤上の空きマスであることを確認します。
    -   持ちコマが「ヒヨコ」の場合、配置先が相手陣地の最終ラインでないことを確認します。
2.  **盤面の更新:**
    -   検証を通過した場合、選択された持ちコマをプレイヤーの持ちコマリストから削除し、指定された空きマスに配置します。
3.  **勝利判定:**
    -   持ちコマを打つことによって勝利条件が満たされることはルール上ないため、判定は行いません。
4.  **手番の交代:**
    -   手番を相手プレイヤーに交代します。

## 4. 無効な操作とコンソールエラー
プレイヤーがルール上許可されていない操作を行った場合、システムはその操作を無視してゲームの状態を変更せず、開発者コンソールにエラーメッセージを出力します。

| シナリオ | コンソールエラーメッセージ |
| :--- | :--- |
| 選択した駒を、ルール上移動できないマスに移動しようとする | `Invalid move: Cannot move <PIECE_TYPE> from (<from_row>, <from_col>) to (<to_row>, <to_col>).` |
| 選択した駒を、味方の駒が既に存在するマスに移動しようとする | `Invalid move: Cannot move <PIECE_TYPE> from (<from_row>, <from_col>) to (<to_row>, <to_col>).` |
| ゲームが終了した後に操作しようとする | `Invalid action: The game is already over.` |
| 相手の駒や空のセルを選択しようとする | `Invalid selection: Cannot select cell (<row>, <col>) as it is empty or belongs to the opponent.` |

---
## 本資料で定義すべきこと
- 千日手（同じ局面が4回出現するなど）や、連続王手の千日手といった、特殊な引き分けに関するルールの要否、およびそれを判定するためのロジック。現在の実装には含まれていないため、導入する場合は詳細な仕様定義が必要です。