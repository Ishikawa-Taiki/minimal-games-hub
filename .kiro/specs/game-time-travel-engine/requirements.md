# 要件定義書 - ゲーム状態管理の合成化（Phase 1）

## はじめに

本プロジェクトの全ゲームにおいて、状態管理を「初期状態 + アクション列の合成」で統一的に管理できるシステムを構築する。これは段階的開発の第1フェーズであり、後続のフェーズ（任意盤面再現、ユーザー履歴遷移）の基盤となる。

本機能は、プロジェクトの3階層設計（ルール、システム動作、システム表示）に準拠し、既存のアーキテクチャとの互換性を保つ。

## 要件

### 要件1: 状態合成管理の統一

**ユーザーストーリー:** ゲーム開発者として、全てのゲームの状態管理を「初期状態 + アクション列の合成」で統一的に扱えるようにしたい。これにより、状態の予測可能性と再現性が向上する。

#### 受入基準

1. WHEN ゲームの状態が変更される時 THEN 初期状態とアクション列から現在の状態が導出される SHALL
2. WHEN アクションが実行される時 THEN そのアクションは純粋関数として状態遷移を表現する SHALL
3. WHEN 同じ初期状態と同じアクション列が与えられた時 THEN 常に同じ最終状態が得られる SHALL
4. WHEN ゲームをリセットする時 THEN アクション列が空になり初期状態に戻る SHALL

### 要件2: 汎用状態管理エンジン

**ユーザーストーリー:** システム設計者として、ゲーム固有のロジックに依存しない汎用的な状態管理エンジンを構築したい。これにより、全ゲームで再利用可能な基盤が得られる。

#### 受入基準

1. WHEN useGameEngineフックを使用する時 THEN ゲーム固有のreducerと初期状態を注入することで動作する SHALL
2. WHEN 状態を取得する時 THEN アクション列をreducerで畳み込んで計算される SHALL
3. WHEN アクションを実行する時 THEN アクション列に追加され状態が再計算される SHALL
4. WHEN 異なるゲームで使用する時 THEN 同じエンジンが型安全に動作する SHALL

### 要件3: 既存システムとの互換性

**ユーザーストーリー:** 既存のゲーム開発者として、現在の実装を大幅に変更することなく、新しい状態管理システムを導入したい。

#### 受入基準

1. WHEN 既存のcore.tsを変更する時 THEN 最小限の修正でreducer形式に変換できる SHALL
2. WHEN 既存のカスタムフックを更新する時 THEN useGameEngineをラップする形で移行できる SHALL
3. WHEN 既存のUIコンポーネントを使用する時 THEN インターフェースの変更なしで動作する SHALL
4. WHEN 段階的に移行する時 THEN 一部のゲームのみ新システムでも全体が正常動作する SHALL

### 要件4: テスト容易性の向上

**ユーザーストーリー:** 品質保証担当者として、状態遷移ロジックを独立してテストできるようにしたい。これにより、バグの特定と修正が効率化される。

#### 受入基準

1. WHEN reducerをテストする時 THEN 純粋関数として入力と出力のみでテストできる SHALL
2. WHEN 状態管理エンジンをテストする時 THEN ゲーム固有のロジックに依存しない単体テストが実行できる SHALL
3. WHEN 複雑な状態遷移をテストする時 THEN アクション列を組み合わせてテストケースを作成できる SHALL
4. WHEN 状態の一貫性をテストする時 THEN 同じアクション列で常に同じ結果が得られることを検証できる SHALL