# 要件定義書 - ゲーム共通タイムトラベル機能

## はじめに

本プロジェクトの全ゲームに対して、履歴操作（タイムトラベル）機能と任意状態の再現機能を提供する共通システムを構築する。これにより、ゲーム開発の効率化、テストの容易性向上、デバッグ支援、特殊な難易度設定などを実現する。

本機能は、プロジェクトの3階層設計（ルール、システム動作、システム表示）に準拠し、既存のレスポンシブアーキテクチャ（PCサイドバー、モバイルFAB+ボトムシート）と統合される。

## 要件

### 要件1: タイムトラベル操作機能

**ユーザーストーリー:** ゲーム開発者として、任意のゲームで履歴を自由に操作できるようにしたい。これにより、デバッグやテストが効率化され、ゲームバランスの調整が容易になる。

#### 受入基準

1. WHEN ユーザーが「一手戻る」操作を実行した時 THEN システムは現在の状態から一手前の状態に戻る SHALL
2. WHEN ユーザーが「一手進む」操作を実行した時 THEN システムは戻した状態から一手後の状態に進む SHALL  
3. WHEN ユーザーが「最初に戻る」操作を実行した時 THEN システムはゲーム開始時の初期状態に移動する SHALL
4. WHEN ユーザーが「最新に進む」操作を実行した時 THEN システムは最新の進行状態に移動する SHALL
5. WHEN ユーザーが特定の履歴位置を指定した時 THEN システムはその位置の状態に移動する SHALL
6. WHEN 履歴の最初にいる時 THEN 「一手戻る」操作は無効化される SHALL
7. WHEN 履歴の最後にいる時 THEN 「一手進む」操作は無効化される SHALL

### 要件2: 状態再現機能

**ユーザーストーリー:** テスト開発者として、複雑な盤面状態を直接設定してテストを開始できるようにしたい。これにより、特定のシナリオのテストケース作成が容易になる。

#### 受入基準

1. WHEN 任意のゲーム状態データが提供された時 THEN システムはその状態を新しい初期状態として設定する SHALL
2. WHEN 状態が再現された時 THEN 履歴は空の状態でリセットされる SHALL
3. WHEN 再現された状態から操作を行った時 THEN 新しい履歴が正常に記録される SHALL
4. IF 無効な状態データが提供された時 THEN システムはエラーを返し、現在の状態を維持する SHALL

### 要件3: 選択的機能採用とインターフェース設計

**ユーザーストーリー:** ゲーム開発者として、ゲームの性質に応じてタイムトラベル機能を選択的に採用できるようにしたい。これにより、必要な機能のみを実装でき、不要な複雑性を避けられる。

#### 受入基準

1. WHEN ゲームでタイムトラベル機能を採用する時 THEN HistoryGameControllerインターフェースを実装することで機能が利用できる SHALL
2. WHEN ゲームでタイムトラベル機能を採用しない時 THEN BaseGameControllerのみの実装で動作する SHALL
3. WHEN ヒント機能とタイムトラベル機能を両方採用する時 THEN HintableGameController & HistoryGameControllerの複合型で実装できる SHALL
4. WHEN 新しいゲームを追加する時 THEN 必要な機能インターフェースのみを選択して実装できる SHALL
5. WHEN GameLayoutコンポーネントを使用する時 THEN 実装されたインターフェースに応じて適切なUI要素が表示される SHALL

### 要件4: レスポンシブUI統合

**ユーザーストーリー:** ユーザーとして、PCとモバイルの両方で一貫したタイムトラベル操作体験を得たい。これにより、デバイスに関係なく同じ機能を利用できる。

#### 受入基準

1. WHEN PCレイアウトでタイムトラベル操作を行う時 THEN サイドバーのコントロールパネルから実行できる SHALL
2. WHEN モバイルレイアウトでタイムトラベル操作を行う時 THEN FABから開くボトムシートのコントロールパネルから実行できる SHALL
3. WHEN コントロールパネルを表示する時 THEN 現在の履歴位置と操作可能性が視覚的に示される SHALL
4. WHEN レイアウトが切り替わった時 THEN タイムトラベル機能の状態は保持される SHALL

### 要件5: メモリ効率性とアクションベース履歴

**ユーザーストーリー:** システム管理者として、長時間のゲームプレイでもメモリ使用量が適切に管理されるようにしたい。これにより、システムの安定性が保たれる。

#### 受入基準

1. WHEN 履歴が蓄積される時 THEN 状態スナップショットではなくアクションベースで記録される SHALL
2. WHEN 現在の状態を取得する時 THEN 初期状態とアクション履歴から動的に計算される SHALL
3. WHEN メモリ使用量を測定する時 THEN 従来の状態スナップショット方式より効率的である SHALL
4. WHEN アクションが実行される時 THEN そのアクションは純粋関数として状態遷移を表現する SHALL

### 要件6: テスト容易性とデバッグ支援

**ユーザーストーリー:** 品質保証担当者として、タイムトラベル機能とゲームロジックを独立してテストできるようにしたい。これにより、バグの特定と修正が効率化される。

#### 受入基準

1. WHEN タイムトラベル機能をテストする時 THEN ゲーム固有のロジックに依存しない単体テストが実行できる SHALL
2. WHEN ゲーム固有のロジックをテストする時 THEN タイムトラベル機能に依存しない単体テストが実行できる SHALL
3. WHEN 状態遷移をテストする時 THEN 純粋関数として独立してテストできる SHALL
4. WHEN GameDebuggerでデバッグする時 THEN アクション履歴と状態遷移が監視できる SHALL
5. WHEN 複雑な盤面をテストする時 THEN 状態再現機能により簡単にテストケースを作成できる SHALL

### 要件7: 既存システムとの互換性と段階的移行

**ユーザーストーリー:** 既存のゲーム開発者として、現在のゲーム実装を大幅に変更することなく、段階的にタイムトラベル機能を導入したい。

#### 受入基準

1. WHEN 既存のゲームに機能を追加する時 THEN 既存のcore.tsロジックは最小限の変更で済む SHALL
2. WHEN 既存のUIコンポーネントを更新する時 THEN インターフェースの変更は最小限に抑えられる SHALL
3. WHEN 新機能を導入する時 THEN 既存のテストケースは引き続き動作する SHALL
4. WHEN 共通部品を実装する時 THEN ゲーム固有の関心事が混入しない抽象化された設計である SHALL
5. WHEN BaseGameControllerインターフェースを拡張する時 THEN 既存の実装との後方互換性が保たれる SHALL
6. WHEN 既存ゲームを段階的に移行する時 THEN 一部のゲームのみタイムトラベル対応でも全体が正常動作する SHALL
7. WHEN リバーシの既存履歴機能を置き換える時 THEN 新しい共通システムへスムーズに移行できる SHALL

### 要件8: 3階層設計との統合

**ユーザーストーリー:** アーキテクト担当者として、プロジェクトの3階層設計（ルール、システム動作、システム表示）に準拠した実装にしたい。これにより、設計の一貫性が保たれる。

#### 受入基準

1. WHEN ルール層をテストする時 THEN タイムトラベル機能により状態遷移ロジックが単独で検証できる SHALL
2. WHEN システム動作層をテストする時 THEN アクション履歴により操作シーケンスが検証できる SHALL
3. WHEN システム表示層をテストする時 THEN 任意の状態を再現してUI表示が検証できる SHALL
4. WHEN 新しいゲームを実装する時 THEN 3階層それぞれでタイムトラベル機能の恩恵を受けられる SHALL
### 要件9: 型安全性とインターフェース合成

**ユーザーストーリー:** TypeScript開発者として、ゲームの機能組み合わせが型レベルで保証されるようにしたい。これにより、コンパイル時にインターフェースの不整合を検出できる。

#### 受入基準

1. WHEN ゲームコントローラーの型を定義する時 THEN 採用する機能に応じた適切な型合成ができる SHALL
2. WHEN GameLayoutコンポーネントで型チェックする時 THEN 実装されていない機能へのアクセスがコンパイルエラーになる SHALL
3. WHEN 新しい補助機能を追加する時 THEN 既存の型合成パターンを踏襲して拡張できる SHALL
4. WHEN useGameEngineフックを使用する時 THEN ゲーム固有の型パラメータが適切に推論される SHALL
5. IF HistoryGameControllerを実装していないゲーム THEN 履歴関連のUIコンポーネントは表示されない SHALL