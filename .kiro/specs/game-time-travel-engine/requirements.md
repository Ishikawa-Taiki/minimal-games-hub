# 要件定義書 - 汎用ゲームエンジン

## はじめに

本プロジェクトの全ゲームにおいて、状態管理を「初期状態 + アクション列の合成」で統一的に管理できるシステムを構築する。本ドキュメントは、そのための要件をフェーズごとに定義する。

-   **Phase 1**: 状態管理の基盤となる、アクション合成によるエンジンを構築する。（完了）
-   **Phase 2**: Phase 1の基盤上に、タイムトラベル機能と状態再現機能を追加する。（今回計画）

---

## Phase 1: 状態合成基盤の構築（完了）

### 要件1: 状態合成管理の統一

**ユーザーストーリー:** ゲーム開発者として、全てのゲームの状態管理を「初期状態 + アクション列の合成」で統一的に扱えるようにしたい。これにより、状態の予測可能性と再現性が向上する。

#### 受入基準

1. WHEN ゲームの状態が変更される時 THEN 初期状態とアクション列から現在の状態が導出される SHALL
2. WHEN アクションが実行される時 THEN そのアクションは純粋関数として状態遷移を表現する SHALL
3. WHEN 同じ初期状態と同じアクション列が与えられた時 THEN 常に同じ最終状態が得られる SHALL
4. WHEN ゲームをリセットする時 THEN アクション列が空になり初期状態に戻る SHALL

### 要件2: 汎用状態管理エンジン

**ユーザーストーリー:** システム設計者として、ゲーム固有のロジックに依存しない汎用的な状態管理エンジンを構築したい。これにより、全ゲームで再利用可能な基盤が得られる。

#### 受入基準

1. WHEN useGameEngineフックを使用する時 THEN ゲーム固有のreducerと初期状態を注入することで動作する SHALL
2. WHEN 状態を取得する時 THEN アクション列をreducerで畳み込んで計算される SHALL
3. WHEN アクションを実行する時 THEN アクション列に追加され状態が再計算される SHALL
4. WHEN 異なるゲームで使用する時 THEN 同じエンジンが型安全に動作する SHALL

### 要件3: 既存システムとの互換性

**ユーザーストーリー:** 既存のゲーム開発者として、現在の実装を大幅に変更することなく、新しい状態管理システムを導入したい。

#### 受入基準

1. WHEN 既存のcore.tsを変更する時 THEN 最小限の修正でreducer形式に変換できる SHALL
2. WHEN 既存のカスタムフックを更新する時 THEN useGameEngineをラップする形で移行できる SHALL
3. WHEN 既存のUIコンポーネントを使用する時 THEN インターフェースの変更なしで動作する SHALL
4. WHEN 段階的に移行する時 THEN 一部のゲームのみ新システムでも全体が正常動作する SHALL

### 要件4: テスト容易性の向上

**ユーザーストーリー:** 品質保証担当者として、状態遷移ロジックを独立してテストできるようにしたい。これにより、バグの特定と修正が効率化される。

#### 受入基準

1. WHEN reducerをテストする時 THEN 純粋関数として入力と出力のみでテストできる SHALL
2. WHEN 状態管理エンジンをテストする時 THEN ゲーム固有のロジックに依存しない単体テストが実行できる SHALL
3. WHEN 複雑な状態遷移をテストする時 THEN アクション列を組み合わせてテストケースを作成できる SHALL
4. WHEN 状態の一貫性をテストする時 THEN 同じアクション列で常に同じ結果が得られることを検証できる SHALL

---

## Phase 2: タイムトラベル機能の実装

### 要件5: タイムトラベル機能 (Undo/Redo)

**ユーザーストーリー:** ゲームプレイヤーとして、自分の手を一手戻したり、戻した手を進めたりして、ゲームの進行を自由に行き来したい。

#### 受入基準

1. WHEN `undo`を呼び出した時 THEN ゲームの状態が一手前の状態に戻る SHALL
2. WHEN `redo`を呼び出した時 THEN `undo`で戻した状態から一手後の状態に進む SHALL
3. WHEN 履歴の先頭にいる時 THEN `undo`は実行できない SHALL
4. WHEN 履歴の最後にいる時 THEN `redo`は実行できない SHALL
5. WHEN `goToIndex`を呼び出した時 THEN 履歴の指定したインデックスの状態に移動できる SHALL

### 要件6: 履歴の分岐

**ユーザーストーリー:** ゲームプレイヤーとして、過去の手番に戻って別の手を試した場合、新しいゲーム展開として履歴が更新されてほしい。

#### 受入基準

1. GIVEN プレイヤーが`undo`で過去の状態に戻っている状態で
2. WHEN 新しいアクションを`dispatch`した時
3. THEN 現在のインデックス以降の古い履歴は破棄され、新しいアクションが履歴の末尾に追加される SHALL

### 要件7: 状態再現機能 (Reconstruction)

**ユーザーストーリー:** 開発者として、特定の局面（アクション列）を直接エンジンに読み込ませて、テストやデバッグを効率的に行いたい。

#### 受入基準

1. WHEN `reconstruct`にアクションの配列を渡した時 THEN エンジンはそのアクション列を元に新しい状態を構築する SHALL
2. WHEN 状態が再現された後 THEN 通常通りゲームを続行できる SHALL