# 実装計画 - ゲーム状態管理の合成化（Phase 1）

## 概要

本実装計画では、要件定義と設計書に基づき、全ゲーム共通の状態管理を「初期状態 + アクション列の合成」で統一するシステムを段階的に実装する。

## タスク一覧

### 1. 基盤実装（既存ゲームに影響なし）

- [x] 1.1 useGameEngine フックの新規作成
  - `src/core/hooks/useGameEngine.ts` として新規ファイル作成
  - 既存のゲームフックには一切影響を与えない独立実装
  - `gameState`, `dispatch`, `reset` の基本機能
  - `actions`, `initialState`, `reducer` の読み取り専用アクセス
  - _要件: 1.1, 2.1, 2.2_

- [x] 1.2 GameEngineDebugUtils クラスの新規作成
  - `src/core/debug/gameEngineDebugUtils.ts` として新規ファイル作成
  - 既存のデバッグ機能には影響を与えない独立実装
  - `computeStateFromActions`, `computeStateAtIndex` メソッド
  - `validateActionSequence`, `analyzeStateDiff` メソッド
  - _要件: 4.1, 4.2, 4.3_

- [x] 1.3 useGameEngine の単体テスト作成
  - `src/core/hooks/__tests__/useGameEngine.test.ts` として新規作成
  - 既存テストには影響なし
  - 基本的な状態管理機能のテスト
  - アクション実行、リセット機能のテスト
  - 状態の一貫性検証テスト
  - _要件: 4.4_

- [x] 1.4 GameEngineDebugUtils の単体テスト作成
  - `src/core/debug/__tests__/gameEngineDebugUtils.test.ts` として新規作成
  - 既存テストには影響なし
  - デバッグユーティリティ機能のテスト
  - アクション列妥当性検証のテスト
  - 状態差分分析のテスト
  - _要件: 4.1, 4.2_

### 2. TicTacToe ゲームでの検証実装（独立移行）

- [x] 2.1 TicTacToe の reducer 実装
  - `src/games/tictactoe/reducer.ts` として新規作成
  - 既存の `core.ts` は変更せず、そのロジックを活用
  - `TicTacToeAction` 型の定義
  - `ticTacToeReducer` 関数の実装
  - _要件: 1.1, 1.2_

- [x] 2.2 新しい useTicTacToe フックの作成
  - `src/games/tictactoe/useTicTacToeNew.ts` として新規作成
  - 既存の `useTicTacToe.ts` は残したまま
  - useGameEngine を使用した実装
  - 既存インターフェースとの互換性を保持
  - _要件: 3.2, 3.3_

- [x] 2.3 TicTacToe の新実装テスト作成
  - 新しい reducer とフックの単体テスト
  - 純粋関数としての reducer テスト
  - useGameEngine統合テスト
  - _要件: 4.1_

- [x] 2.4 TicTacToe の切り替えと旧実装削除
  - `useTicTacToe.ts` を新実装に置き換え
  - `useTicTacToeNew.ts` を `useTicTacToe.ts` にリネーム
  - 旧実装ファイルの削除
  - 動作確認テストの実行
  - _要件: 4.3_

### 3. リバーシゲームでの移行実装（独立移行）

- [ ] 3.1 リバーシの reducer 実装
  - `src/games/reversi/reducer.ts` として新規作成
  - 既存の `core.ts` は変更せず、そのロジックを活用
  - `ReversiAction` 型の定義（ヒント機能含む）
  - `reversiReducer` 関数の実装
  - _要件: 1.1, 1.2_

- [ ] 3.2 新しい useReversi フックの作成
  - `src/games/reversi/useReversiNew.ts` として新規作成
  - 既存の `useReversi.ts` は残したまま
  - useGameEngine を使用した実装
  - 複雑な履歴管理を useGameEngine に置き換え
  - _要件: 3.1, 3.2_

- [ ] 3.3 リバーシの新実装テスト作成
  - 新しい reducer とフックの単体テスト
  - 既存実装との動作比較テスト
  - ヒント機能を含むアクションのテスト
  - パフォーマンス比較（メモリ使用量）
  - _要件: 3.4, 4.1_

- [ ] 3.4 リバーシの切り替えと旧実装削除
  - `useReversi.ts` を新実装に置き換え
  - `useReversiNew.ts` を `useReversi.ts` にリネーム
  - 旧実装ファイルの削除
  - 動作確認テストの実行
  - _要件: 4.3_

### 5. 残りゲームの段階的移行

- [ ] 5.1 残りゲーム（4つ程度）の移行計画策定
  - 各ゲームの複雑度を評価
  - 移行優先順位の決定
  - 各ゲーム独立した移行スケジュール作成
  - _要件: 3.4_

- [ ] 5.2 各ゲームの個別移行実装
  - ゲーム毎に 2.1-2.4 と同様のプロセスを実行
  - `reducer.ts` の新規作成
  - `useGameNew.ts` の新規作成
  - 動作比較テストの実行
  - 切り替えと旧実装削除
  - _要件: 3.1, 3.2, 3.3_

### 6. インターフェース最適化とクリーンアップ

- [ ] 6.1 BaseGameController インターフェースの最適化
  - 全ゲーム移行完了後に実施
  - useGameEngine ベースの新しい設計に最適化
  - 不要な dispatch プロパティの削除
  - より良い抽象化への変更
  - _要件: 3.1_

- [ ] 6.2 GameLayout コンポーネントの最適化
  - 新しいインターフェースに対応した表示
  - デバッグ情報の表示オプション追加
  - レスポンシブレイアウトでの動作確認
  - _要件: 3.3_

- [ ] 6.3 型定義の整理とクリーンアップ
  - 新しい設計に合わせた型定義の見直し
  - 旧実装関連の型定義を完全削除
  - TypeScript の型推論の最適化
  - 未使用インポートの削除
  - _要件: 2.4_

### 7. ドキュメント更新と最終検証

- [ ] 7.1 技術ドキュメントの更新
  - technical-guide-application-architecture.md の更新
  - 新しい状態管理パターンの説明追加
  - 移行ガイドの作成
  - _要件: 3.1_

- [ ] 7.2 全ゲームでの最終動作確認
  - 全6ゲームでの最終動作確認
  - パフォーマンス測定（メモリ使用量、レンダリング）
  - 既存機能の回帰テスト
  - _要件: 3.4_

- [ ] 7.3 コードベースの最終クリーンアップ
  - 旧実装の残骸が完全に削除されていることを確認
  - 未使用ファイル・インポートの削除
  - コードフォーマットの統一
  - リファクタリング後のコード品質確認
  - _要件: 全体品質_

- [ ] 7.4 Phase 2 準備
  - 任意盤面再現機能の設計準備
  - Phase 1 で得られた知見の整理
  - Phase 2 要件定義の準備
  - _要件: 将来拡張性_

## 実装順序の方針

1. **基盤優先**: useGameEngine とデバッグユーティリティを完全独立で実装
2. **ゲーム個別移行**: 各ゲームを完全に独立して移行（他ゲームに影響なし）
3. **新旧並行**: 移行中は新旧実装が並行稼働（動作比較可能）
4. **段階的切り替え**: 動作確認後に旧実装を削除
5. **最終クリーンアップ**: 全移行完了後にインターフェース最適化と残骸削除
6. **継続的テスト**: 各段階でテストを並行実装

## 各ゲーム独立移行の保証

### 基盤実装（タスク1）
- ✅ 新規ファイルのみ作成、既存ファイル変更なし
- ✅ 既存ゲームへの影響ゼロ

### 各ゲーム移行（タスク2-5）
- ✅ `reducer.ts` 新規作成（既存 `core.ts` 無変更）
- ✅ `useGameNew.ts` 新規作成（既存フック無変更）
- ✅ 動作比較テスト後に切り替え
- ✅ 旧実装削除でクリーンアップ

### 移行可能性
- ✅ 6つのゲームを完全に独立して移行可能
- ✅ 任意の順序で移行可能
- ✅ 移行中断・再開が可能

## 成功基準

- [ ] 全ゲームが「初期状態 + アクション列」で状態管理されている
- [ ] reducer が純粋関数として実装され、独立してテスト可能
- [ ] デバッグ機能により任意の状態を再現・検証可能
- [ ] 既存機能が全て正常動作している
- [ ] メモリ使用量が従来方式より効率的
- [ ] Phase 2, 3 の実装基盤が整っている